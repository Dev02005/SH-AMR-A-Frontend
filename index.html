<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="description" content="S&H ARABIAN MANDI RESTAURANT POS System - Professional point of sale billing software for mandi restaurants. Features thermal printing, payment tracking (Cash/Card/UPI), delivery platform integration (Zomato/Swiggy), and custom item billing. Located at Sangivalasa, Vishakapatnam, AP.">
<meta name="keywords" content="POS system, mandi restaurant, biryani, tandoori, mandi billing, restaurant billing software, thermal printer, Vishakapatnam restaurants, Zomato orders, Swiggy orders, cloud kitchen POS, food billing system">
<meta name="author" content="CSE 88 DEV">
<meta name="robots" content="index, follow">
<meta name="theme-color" content="#ffd54f">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="S&H ARABIAN MANDI RESTAURANT POS">

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website">
<meta property="og:title" content="S&H ARABIAN MANDI RESTAURANT - Mandi | Chinese | Tandoori | Meals | Snacks | Biryani POS System">
<meta property="og:description" content="Professional POS billing system for mandi restaurants with thermal printing, payment tracking, and delivery integration">
<meta property="og:site_name" content="S&H ARABIAN MANDI RESTAURANT">
<meta property="og:locale" content="en_IN">

<!-- Twitter -->
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="S&H ARABIAN MANDI RESTAURANT - Mandi | Chinese | Tandoori | Meals | Snacks | Biryani POS">
<meta name="twitter:description" content="Professional restaurant POS system with thermal printing and delivery integration">

<!-- Canonical URL -->
<link rel="canonical" href="https://www.srivengamambafoodcourt.com/">

<title>S&H ARABIAN MANDI RESTAURANT – Mandi | Chinese | Tandoori | Meals | Snacks | Biryani | Billing System</title>

<style>
:root{
--bg:#0F120D;
--panel:#1B1F17;
--card-bg:#1B1F17;
--text:#FFFFFF;
--muted:#A1A1AA;
--accent:#A3E635;
--primary:#4D7C0F;
--danger:#C62828;
--gold:var(--accent);
--gold-dark:var(--accent);
--red:var(--danger);
--hover-glow:rgba(163, 230, 53, 0.18);
}

/* ===== GLOBAL ===== */
*{box-sizing:border-box;}
html, body{
margin:0;
padding:0;
min-height:100%;
font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
background:linear-gradient(135deg, var(--bg) 0%, var(--panel) 100%);
color:var(--text);
}

@media screen{
body{zoom:1.08;}
}

/* ===== HEADER ===== */
.header{
flex-shrink:0;
text-align:center;
padding:16px 20px 12px;
background:linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
border-bottom:3px solid var(--gold-dark);
box-shadow:0 4px 20px rgba(0,0,0,0.5);
position:relative;
min-height:90px;
}

.header h1{
margin:0;
font-size:clamp(18px, 3.5vw, 32px);
color:var(--gold);
text-shadow:2px 2px 8px rgba(255, 213, 79, 0.3);
letter-spacing:clamp(0.5px, 0.15vw, 1px);
padding:0 140px;
line-height:1.2;
display:flex;
align-items:center;
justify-content:center;
gap:10px;
flex-wrap:wrap;
}

.brand-s{color:#43a047;}
.brand-amp{color:#000;}
.brand-h{color:#c98f0a;}
.brand-logo{
height:26px;
width:26px;
display:inline-block;
vertical-align:middle;
border-radius:50%;
object-fit:cover;
background:#fff;
border:1px solid rgba(0,0,0,0.2);
box-shadow:0 2px 6px rgba(0,0,0,0.35);
}

@media (max-width: 600px){
  .brand-logo{height:22px;width:22px;}
}

.header h3{
margin:6px 0 0;
color:var(--muted);
font-weight:400;
font-size:clamp(12px, 1.9vw, 15px);
padding:0 140px;
line-height:1.3;
}

@media (max-width: 900px){
.header h1{
padding:0 110px;
font-size:clamp(16px, 4vw, 28px);
}
.header h3{
padding:0 110px;
}
}

@media (max-width: 600px){
.header{
padding:12px 10px 10px;
min-height:80px;
}
.header h1{
padding:0 85px;
}
.header h3{
padding:0 85px;
margin:4px 0 0;
}
}

.header-info{
display:flex;
justify-content:space-between;
align-items:flex-start;
flex-wrap:wrap;
width:100%;
margin:8px 0 0 0;
padding:0 20px;
gap:20px;
}

.location, .owner{
color:var(--muted);
font-size:clamp(11px, 1.5vw, 13px);
display:flex;
flex-direction:row;
align-items:flex-start;
flex-wrap:wrap;
gap:0;
}

.location strong, .owner strong{
color:var(--gold);
font-weight:600;
white-space:nowrap;
margin-right:6px;
}

.header-top-row{
width:100%;
display:flex;
justify-content:space-between;
align-items:flex-start;
flex-wrap:wrap;
gap:8px;
padding:0 20px 6px 20px;
margin-bottom:-2px;
position:relative;
top:-8px;
}

.header-icons{
display:flex;
gap:6px;
align-items:center;
flex-wrap:wrap;
position:static;
justify-content:flex-start;
flex:1;
min-width:180px;
}

.analytics-btn-wrapper{
display:flex;
align-items:center;
position:static;
justify-content:flex-end;
flex:1;
min-width:140px;
}

@media (max-width: 900px){
.header-icons{
gap:5px;
}
.analytics-btn-wrapper{
gap:5px;
}
.header-top-row{
padding:0 12px;
gap:6px;
}
}

@media (max-width: 768px){
.header-top-row{
padding:0 10px;
gap:6px;
}
.header-icons,
.analytics-btn-wrapper{
min-width: auto;
}
.header-icon-btn{
padding:8px 12px !important;
font-size:clamp(11px, 2vw, 13px) !important;
min-width:75px !important;
}
.user-name{
font-size:clamp(10px, 1.8vw, 12px) !important;
margin-right:2px !important;
display:none;
}
}

@media (max-width: 600px){
.header-top-row{
padding:0 8px;
gap:4px;
}
.header-icons{
gap:4px;
}
.header-icon-btn{
padding:6px 10px !important;
font-size:11px !important;
min-width:60px !important;
}
.user-name{
display:none !important;
}
}

.user-info{
display:flex;
align-items:center;
gap:4px;
flex-wrap:wrap;
}

.header-icon-btn{
background:var(--accent);
color:#000;
border:none;
border-radius:8px;
width:auto;
height:auto;
cursor:pointer;
font-size:clamp(12px, 1.5vw, 15px);
font-weight:600;
display:flex;
align-items:center;
justify-content:center;
transition:all 0.3s ease;
box-shadow:0 3px 10px rgba(255, 213, 79, 0.3);
-webkit-tap-highlight-color:transparent;
user-select:none;
padding:9px 15px;
min-width:90px;
}

@media (max-width: 900px){
.header-icon-btn{
padding:8px 13px;
min-width:80px;
font-size:12px;
}
}

.header-icon-btn:hover{
transform:translateY(-2px);
box-shadow:0 6px 16px rgba(212, 160, 23, 0.5);
}

.header-icon-btn:active{
transform:scale(0.95);
}

/* ===== SETTINGS DROPDOWN ===== */
.settings-container{
position:relative;
display:flex;
align-items:center;
}

.settings-btn{
background:var(--accent);
color:#000;
border:none;
border-radius:8px;
width:auto;
height:auto;
cursor:pointer;
font-size:clamp(12px, 1.5vw, 15px);
font-weight:600;
display:flex;
align-items:center;
justify-content:center;
transition:all 0.3s ease;
box-shadow:0 3px 10px rgba(255, 213, 79, 0.3);
padding:9px 15px;
min-width:90px;
-webkit-tap-highlight-color:transparent;
user-select:none;
}

@media (max-width: 900px){
.settings-btn{
padding:8px 13px;
min-width:80px;
font-size:12px;
}
}

@media (max-width: 768px){
.settings-btn{
padding:8px 12px;
min-width:75px;
font-size:11px;
}
}

@media (max-width: 600px){
.settings-btn{
padding:6px 10px;
min-width:60px;
font-size:10px;
}
}

.settings-btn:hover{
transform:translateY(-2px);
box-shadow:0 6px 16px rgba(212, 160, 23, 0.5);
}

.settings-btn:active{
transform:scale(0.95);
}


.settings-dropdown{
  position:absolute;
  top:100%;
  left:0;
  right:auto;
  margin-top:8px;
  margin-left:0;
  background:var(--panel);
  border:2px solid var(--accent);
  border-radius:8px;
  box-shadow:0 8px 24px rgba(0,0,0,0.6);
  z-index:1000;
  min-width:200px;
  overflow:visible;
  opacity:0;
  visibility:hidden;
  transform:translateY(10px) scale(0.98);
  transition:all 0.25s cubic-bezier(.4,1.6,.6,1);
}

@media (max-width: 600px){
.settings-dropdown{
min-width:180px;
margin-left:8px;
}
}

.settings-dropdown.active{
  opacity:1;
  visibility:visible;
  transform:translateY(0) scale(1);
}

.dropdown-user-info{
padding:12px 16px;
border-bottom:2px solid rgba(163, 230, 53, 0.25);
text-align:center;
}

.dropdown-user-name{
font-size:14px;
font-weight:600;
color:var(--accent);
display:block;
text-transform:capitalize;
}

.settings-dropdown button{
display:block;
width:100%;
padding:12px 16px;
background:none;
border:none;
color:var(--text);
text-align:left;
cursor:pointer;
font-size:14px;
font-weight:500;
transition:all 0.2s ease;
border-bottom:1px solid rgba(163, 230, 53, 0.15);
}

.settings-dropdown button:last-child{
border-bottom:none;
}

.settings-dropdown button:hover{
background:rgba(163, 230, 53, 0.1);
color:var(--accent);
padding-left:20px;
}

.settings-dropdown button:active{
background:rgba(163, 230, 53, 0.2);
}

.edit-menu-section{
display:flex;
flex-direction:column;
gap:0;
border-bottom:1px solid rgba(163, 230, 53, 0.15);
}

.edit-menu-btn{
display:block;
width:100%;
padding:12px 16px;
background:none;
border:none;
color:var(--text);
text-align:left;
cursor:pointer;
font-size:14px;
font-weight:500;
transition:all 0.2s ease;
border-bottom:1px solid rgba(163, 230, 53, 0.15);
user-select:none;
}

.edit-menu-btn:hover{
background:rgba(163, 230, 53, 0.1);
color:var(--accent);
padding-left:20px;
}

.edit-menu-btn:active{
background:rgba(163, 230, 53, 0.2);
}

.edit-menu-submenu{
display:none;
flex-direction:column;
gap:0;
max-height:0;
overflow:hidden;
transition:max-height 0.3s ease;
}

.edit-menu-submenu.active{
display:flex;
max-height:500px;
}

.dropdown-menu-btn{
display:block;
width:100%;
padding:12px 16px;
background:none;
border:none;
color:var(--text);
text-align:left;
cursor:pointer;
font-size:14px;
font-weight:500;
transition:all 0.2s ease;
border-bottom:1px solid rgba(163, 230, 53, 0.15);
}

.dropdown-menu-btn:last-child{
border-bottom:none;
}

.dropdown-menu-btn:hover{
background:rgba(163, 230, 53, 0.1);
color:var(--accent);
padding-left:20px;
}

.dropdown-menu-btn:active{
background:rgba(163, 230, 53, 0.2);
}

/* ===== LAYOUT ===== */
body{display:flex;flex-direction:column;min-height:100vh;}
.container{
display:flex;
flex:1;
min-height:0;
gap:8px;
padding:8px;
overflow:hidden;
}

@media (max-width: 768px){
.container{
gap:6px;
padding:6px;
}
}

@media (max-width: 600px){
.container{
flex-direction:column;
gap:4px;
padding:4px;
}
}

/* ===== PAGE FOOTER ===== */
.page-footer{
flex-shrink:0;
text-align:center;
font-size:11px;
color:var(--muted);
border-top:2px solid rgba(163, 230, 53, 0.25);
padding:10px;
background:linear-gradient(135deg, #000000 0%, #0a0a0a 100%);
margin-top:auto;
}

.page-footer b{
color:var(--gold);
font-weight:700;
}

/* ===== LEFT ===== */
.left{
width:65%;
min-width:0;
min-height:0;
background:var(--panel);
border-radius:16px;
display:flex;
flex-direction:column;
box-shadow:0 8px 32px rgba(0,0,0,0.4);
border:1px solid rgba(255, 213, 79, 0.1);
overflow:hidden;
}

@media (max-width: 768px){
.left{
width:60%;
}
}

@media (max-width: 600px){
.left{
width:100%;
height:auto;
max-height:60vh;
border-radius:12px;
}
}

.add-to-menu-btn{
width:100%;
padding:14px;
background:var(--primary);
color:#fff;
border:none;
border-radius:8px;
font-size:15px;
font-weight:bold;
cursor:pointer;
box-shadow:0 4px 12px rgba(46, 125, 50, 0.4);
transition:all 0.3s ease;
margin-bottom:12px;
}

.add-to-menu-btn:hover{
transform:translateY(-2px);
box-shadow:0 6px 16px rgba(46, 125, 50, 0.6);
}

.add-to-menu-btn:active{
transform:scale(0.98);
}

.tabs{
flex-shrink:0;
display:flex;
gap:10px;
padding:16px;
background:rgba(0,0,0,0.3);
border-radius:16px 16px 0 0;
flex-wrap:wrap;
}

.tabs button{
flex:1;
min-width:120px;
padding:18px 16px;
background:var(--accent);
color:#000;
border:none;
border-radius:10px;
font-weight:600;
font-size:clamp(13px, 3vw, 17px);
cursor:pointer;
transition:all 0.3s ease;
box-shadow:0 4px 12px rgba(212, 160, 23, 0.3);
-webkit-tap-highlight-color:transparent;
user-select:none;
min-height:50px;
white-space:nowrap;
text-overflow:ellipsis;
text-transform:capitalize;
}

.tabs button:active{
transform:scale(0.97);
}

.tabs button:hover{
transform:translateY(-2px);
box-shadow:0 6px 16px rgba(212, 160, 23, 0.5);
}

.tabs button.active{
background:linear-gradient(135deg, var(--gold-dark) 0%, var(--gold) 100%);
color:#000;
box-shadow:0 6px 20px rgba(255, 179, 0, 0.5);
transform:translateY(-2px);
}

@media (max-width: 1024px){
.tabs{
gap:8px;
padding:14px;
}
.tabs button{
padding:14px 12px;
font-size:clamp(12px, 2.8vw, 15px);
min-width:110px;
}
}

@media (max-width: 768px){
.tabs{
gap:6px;
padding:12px;
}
.tabs button{
padding:12px 10px;
font-size:clamp(11px, 2.5vw, 14px);
min-width:100px;
min-height:44px;
}
}

@media (max-width: 600px){
.tabs{
gap:4px;
padding:10px;
}
.tabs button{
flex:1;
padding:10px 8px;
font-size:clamp(10px, 2.3vw, 13px);
min-width:80px;
min-height:42px;
}
}

.menu{
flex:1;
min-height:0;
overflow:auto;
padding:16px;
display:grid;
grid-template-columns:repeat(auto-fill,minmax(200px,1fr));
gap:16px;
align-content:start;
}

.menu::-webkit-scrollbar{
width:8px;
}

.menu::-webkit-scrollbar-track{
background:rgba(0,0,0,0.2);
border-radius:10px;
}

.menu::-webkit-scrollbar-thumb{
background:var(--gold-dark);
border-radius:10px;
}

@media (max-width: 1024px){
.menu{
grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
gap:14px;
padding:14px;
}
}

@media (max-width: 768px){
.menu{
grid-template-columns:repeat(auto-fill,minmax(160px,1fr));
gap:12px;
padding:12px;
}
}

@media (max-width: 600px){
.menu{
grid-template-columns:repeat(2,1fr);
gap:10px;
padding:10px;
}
}

.menu-item{
position:relative;
padding:24px 20px;
background:linear-gradient(135deg, var(--card-bg) 0%, #333 100%);
border:2px solid transparent;
border-radius:12px;
cursor:pointer;
transition:all 0.3s ease;
box-shadow:0 4px 12px rgba(0,0,0,0.3);
display:flex;
flex-direction:column;
align-items:center;
justify-content:center;
min-height:100px;
-webkit-tap-highlight-color:transparent;
user-select:none;
background-size:cover;
background-position:center;
background-repeat:no-repeat;
overflow:hidden;
}

@media (max-width: 768px){
.menu-item{
padding:18px 16px;
min-height:90px;
}
}

@media (max-width: 600px){
.menu-item{
padding:14px 12px;
min-height:80px;
}
}

.menu-item::before{
content:"";
position:absolute;
top:0;
left:0;
right:0;
bottom:0;
background:linear-gradient(135deg, rgba(42, 42, 42, 0.65) 0%, rgba(51, 51, 51, 0.65) 100%);
z-index:0;
transition:all 0.3s ease;
}

.menu-item[data-has-image]::before{
background:linear-gradient(135deg, rgba(0, 0, 0, 0.35) 0%, rgba(0, 0, 0, 0.45) 100%);
}

.menu-item:hover::before{
background:linear-gradient(135deg, rgba(42, 42, 42, 0.4) 0%, rgba(51, 51, 51, 0.4) 100%);
}

.menu-item[data-has-image]:hover::before{
background:linear-gradient(135deg, rgba(0, 0, 0, 0.2) 0%, rgba(0, 0, 0, 0.3) 100%);
}

.menu-item:active{
transform:scale(0.97);
}

.menu-item:hover{
transform:translateY(-4px);
border-color:var(--gold);
box-shadow:0 8px 24px rgba(255, 213, 79, 0.3);
}

/* Fallback visual when image failed to load */
.menu-item.image-load-failed{
  background-image: linear-gradient(135deg, #f3f4f6 0%, #e6e8eb 100%);
  color: var(--muted);
}
.menu-item.image-load-failed::before{
  background:none;
  opacity:0.6;
}

.item-name{
font-size:14px;
font-weight:600;
color:var(--gold);
margin-bottom:8px;
text-align:center;
position:relative;
z-index:1;
text-shadow:1px 1px 3px rgba(0,0,0,0.8);
}

.item-price{
font-size:18px;
font-weight:bold;
color:var(--gold-dark);
position:relative;
z-index:1;
text-shadow:1px 1px 3px rgba(0,0,0,0.8);
}

@media (max-width: 768px){
.item-name{
font-size:clamp(12px, 2vw, 13px);
margin-bottom:6px;
}
.item-price{
font-size:clamp(15px, 2.5vw, 16px);
}
}

@media (max-width: 600px){
.item-name{
font-size:clamp(11px, 1.8vw, 12px);
margin-bottom:4px;
}
.item-price{
font-size:clamp(13px, 2.2vw, 14px);
}
}

/* ===== BILL PANEL ===== */
.bill .cut-line{display:none;}
.bill{
width:35%;
min-width:0;
min-height:0;
background:linear-gradient(to bottom, #ffffff 0%, #f5f5f5 100%);
color:black;
border-radius:12px;
padding:10px;
display:flex;
flex-direction:column;
box-shadow:0 8px 32px rgba(0,0,0,0.5);
border:2px solid var(--gold-dark);
overflow:hidden;
}

@media (max-width: 768px){
.bill{
width:40%;
padding:8px;
}
}

@media (max-width: 600px){
.bill{
width:100%;
height:auto;
max-height:35vh;
padding:8px;
border-radius:10px;
}
}

.bill-header{
flex-shrink:0;
border-bottom:1px dashed #999;
padding-bottom:6px;
margin-bottom:8px;
text-align:center;
position:relative;
}

.bill-header b{
font-size:15px;
color:#000;
}

.bill-subtitle{
color:#555;
font-size:12px;
margin-top:2px;
}

.bill-number{
text-align:right;
font-size:11px;
color:#000;
font-weight:bold;
margin-bottom:4px;
display:flex;
align-items:center;
justify-content:flex-end;
gap:4px;
}

.bill-no-input{
width:50px;
padding:2px 4px;
border:1px solid #999;
border-radius:4px;
font-size:12px;
font-weight:bold;
text-align:center;
background:white;
color:#000;
}

.bill-no-input:focus{
outline:none;
border-color:var(--gold-dark);
box-shadow:0 0 0 2px rgba(255, 179, 0, 0.2);
}

/* On screen: show input, hide static number; in print the opposite */
.bill-no-display{ display:inline; }

.token-number{
text-align:right;
font-size:12px;
color:#000;
font-weight:bold;
margin-bottom:6px;
}

.datetime{
display:flex;
justify-content:space-between;
font-size:10px;
margin-top:4px;
color:#666;
font-weight:500;
}

.bill-items{
flex:1;
min-height:80px;
overflow:auto;
margin-bottom:6px;
}

.bill-items::-webkit-scrollbar{
width:6px;
}

.bill-items::-webkit-scrollbar-track{
background:#f0f0f0;
border-radius:10px;
}

.bill-items::-webkit-scrollbar-thumb{
background:var(--gold-dark);
border-radius:10px;
}

table{
width:100%;
border-collapse:collapse;
font-size:15px;
margin-bottom:0;
}

th{
background:linear-gradient(135deg, #333 0%, #444 100%);
color:white;
padding:10px 8px;
font-weight:600;
font-size:13px;
position:sticky;
top:0;
z-index:1;
}

td{
border-bottom:1px solid #e0e0e0;
padding:10px 8px;
text-align:center;
}

td.qty-cell{
padding:2px;
}

.qty-controls{
display:flex;
align-items:center;
justify-content:center;
gap:2px;
}

.qty-btn{
background:transparent;
color:#000;
border:none;
border-radius:0;
width:auto;
height:auto;
cursor:pointer;
font-size:16px;
font-weight:bold;
transition:all 0.2s ease;
display:flex;
align-items:center;
justify-content:center;
padding:0 4px;
box-shadow:none;
}

.qty-btn:hover{
background:transparent;
transform:scale(1.1);
}

.qty-btn:active{
transform:scale(0.95);
}

.qty-display{
min-width:20px;
font-weight:600;
font-size:15px;
}

td.remove-cell{
padding:2px;
width:32px;
}

.remove-btn{
background:var(--red);
color:white;
border:none;
border-radius:4px;
padding:5px 10px;
cursor:pointer;
font-size:12px;
font-weight:600;
transition:all 0.2s ease;
min-height:32px;
}

.remove-btn:hover{
background:#b71c1c;
transform:scale(1.05);
}

tr:hover{
background:rgba(255, 213, 79, 0.1);
}

.payment-options{
flex-shrink:0;
margin-bottom:0px;
}

.payment-options label{
display:block;
font-size:14px;
font-weight:600;
margin-bottom:2px;
color:#333;
}

.payment-options select{
width:100%;
padding:6px 12px;
border:1px solid #ddd;
border-radius:6px;
font-size:15px;
background:white;
cursor:pointer;
transition:all 0.2s ease;
min-height:42px;
}

.payment-options select:focus{
outline:none;
border-color:var(--gold-dark);
box-shadow:0 0 0 3px rgba(255, 179, 0, 0.1);
}

.total-section{
flex-shrink:0;
background:linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
color:var(--gold);
padding:8px 10px;
border-radius:8px;
margin-bottom:6px;
margin-top:0;
}

.total{
font-size:20px;
font-weight:bold;
text-align:right;
text-shadow:1px 1px 4px rgba(0,0,0,0.3);
}

.footer{
flex-shrink:0;
text-align:center;
font-size:10px;
color:#666;
border-top:1px dashed #aaa;
margin-top:4px;
padding-top:4px;
}

.footer b{
font-weight:700;
}

.actions{
flex-shrink:0;
display:flex;
gap:8px;
}

.actions button{
flex:1;
padding:10px;
border:none;
border-radius:8px;
font-weight:bold;
font-size:14px;
cursor:pointer;
transition:all 0.3s ease;
-webkit-tap-highlight-color:transparent;
user-select:none;
min-height:44px;
}

.actions button:active{
transform:scale(0.97);
}

.print{
background:linear-gradient(135deg, var(--gold-dark) 0%, var(--gold) 100%);
color:#000;
box-shadow:0 4px 12px rgba(255, 179, 0, 0.4);
}

.print:hover{
transform:translateY(-2px);
box-shadow:0 6px 16px rgba(255, 179, 0, 0.6);
}

.clear{
background:linear-gradient(135deg, #c62828 0%, var(--red) 100%);
color:white;
box-shadow:0 4px 12px rgba(211, 47, 47, 0.4);
}

.clear:hover{
transform:translateY(-2px);
box-shadow:0 6px 16px rgba(211, 47, 47, 0.6);
}

.empty-bill{
text-align:center;
color:#999;
padding:40px 20px;
font-style:italic;
}

.payment-options{
flex-shrink:0;
margin-bottom:0px;
}

.payment-options label{
display:block;
font-size:14px;
font-weight:600;
margin-bottom:2px;
color:#333;
}

.payment-options select{
width:100%;
padding:6px 12px;
border:1px solid #ddd;
border-radius:6px;
font-size:15px;
background:white;
cursor:pointer;
transition:all 0.2s ease;
min-height:42px;
}

.payment-options select:focus{
outline:none;
border-color:var(--gold-dark);
box-shadow:0 0 0 3px rgba(255, 179, 0, 0.1);
}

/* ===== CUSTOM ITEM MODAL ===== */
.add-custom-btn{
position:fixed;
bottom:20px;
right:20px;
width:70px;
height:70px;
background:linear-gradient(135deg, var(--gold-dark) 0%, var(--gold) 100%);
color:#000;
border:none;
border-radius:50%;
font-size:36px;
font-weight:bold;
cursor:pointer;
box-shadow:0 4px 20px rgba(255, 179, 0, 0.6);
z-index:1000;
transition:all 0.3s ease;
display:flex;
align-items:center;
justify-content:center;
}

.add-custom-btn:hover{
transform:scale(1.1);
box-shadow:0 6px 28px rgba(255, 179, 0, 0.8);
}

.add-custom-btn:active{
transform:scale(0.95);
}

.modal{
display:none;
position:fixed;
top:0;
left:0;
width:100%;
height:100%;
background:rgba(0,0,0,0.7);
z-index:2000;
align-items:center;
justify-content:center;
backdrop-filter:blur(4px);
padding:12px;
}

.modal.active{
display:flex;
}

/* Print-confirmation OK popup (shows 2s after Print) */
.print-ok-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.55);z-index:2500;align-items:center;justify-content:center;backdrop-filter:blur(3px);}
.print-ok-modal.active{display:flex}
.print-ok-content{background:white;border-radius:12px;padding:18px 20px;max-width:320px;width:90%;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,0.4);}
.print-ok-content p{margin:0 0 12px;color:#111;font-weight:600}
.print-ok-content .print-ok-btn{padding:10px 18px;border-radius:8px;border:none;background:linear-gradient(135deg,var(--gold-dark) 0%,var(--gold) 100%);color:#000;font-weight:700;cursor:pointer}

.modal-content{
background:white;
border-radius:16px;
padding:18px;
width:90%;
max-width:300px;
box-shadow:0 10px 40px rgba(0,0,0,0.5);
animation:modalSlideIn 0.3s ease;
max-height:92vh;
overflow-y:auto;
/* Hide native scrollbar but keep scroll functionality */
-ms-overflow-style: none;  /* IE and Edge */
scrollbar-width: none;  /* Firefox */
}
.modal-content::-webkit-scrollbar{display:none}
/* Prevent body scroll when modal is open */
.modal-open{overflow:hidden;height:100vh;}

/* Tighter spacing for Add Menu modal to fit smaller screens */
#permanentModal .form-group{
  margin-bottom:12px;
}
#permanentModal .form-group label{
  margin-bottom:4px;
  font-size:12px;
}
#permanentModal .form-group input,
#permanentModal .form-group select{
  padding:8px 10px;
  font-size:13px;
}
#permanentModal .modal-actions{
  gap:8px;
}
#permanentModal .modal-actions button{
  padding:10px 8px;
  font-size:13px;
}

/* Prices grid wrap nicely on small widths */
#permanentModal .price-grid{
  display:grid;
  grid-template-columns:repeat(2, minmax(0,1fr));
  gap:8px;
}

/* Add Menu modal responsiveness */
.add-menu-tabs{
display:flex;
gap:8px;
margin:4px 0 12px;
}
.add-menu-tab{
flex:1;
padding:10px 8px;
text-align:center;
}

@media (max-width: 480px){
  .modal-content{
    width:94%;
    max-width:360px;
    padding:18px;
  }
  .modal-header h2{
    font-size:18px;
  }
  .add-menu-tabs{
    gap:6px;
    margin:2px 0 10px;
  }
  .add-menu-tab{
    padding:8px 6px;
    font-size:12px;
  }
  .form-group label{
    font-size:12px;
  }
  .form-group input,
  .form-group select{
    padding:8px 10px;
    font-size:13px;
  }
  .modal-actions button{
    padding:10px 8px;
    font-size:13px;
  }
}

@keyframes modalSlideIn{
from{
transform:translateY(-50px);
opacity:0;
}
to{
transform:translateY(0);
opacity:1;
}
}

.modal-header{
display:flex;
justify-content:space-between;
align-items:center;
margin-bottom:20px;
}

.modal-header h2{
margin:0;
color:#000;
font-size:22px;
}

.modal-close{
background:none;
border:none;
font-size:28px;
cursor:pointer;
color:#666;
width:32px;
height:32px;
display:flex;
align-items:center;
justify-content:center;
border-radius:50%;
transition:all 0.2s ease;
}

.modal-close:hover{
background:#f0f0f0;
color:#000;
}

.form-group{
margin-bottom:16px;
}

.form-group label{
display:block;
margin-bottom:6px;
font-weight:600;
color:#333;
font-size:14px;
}

.form-group input{
width:100%;
padding:10px 12px;
border:2px solid #ddd;
border-radius:8px;
font-size:15px;
transition:all 0.2s ease;
}

.form-group input:focus{
outline:none;
border-color:var(--gold-dark);
box-shadow:0 0 0 3px rgba(255, 179, 0, 0.1);
}

.form-group select{
width:100%;
padding:10px 12px;
border:2px solid #ffc107;
border-radius:8px;
font-size:15px;
background-color:#fff;
color:#333;
cursor:pointer;
transition:all 0.2s ease;
}

.form-group select:focus{
outline:none;
border-color:var(--gold-dark);
box-shadow:0 0 0 3px rgba(255, 179, 0, 0.1);
}

.form-group select option{
padding:8px;
background-color:#fff;
color:#333;
}

.modal-actions{
display:flex;
gap:10px;
margin-top:20px;
}

.modal-actions button{
flex:1;
padding:12px;
border:none;
border-radius:8px;
font-weight:600;
font-size:15px;
cursor:pointer;
transition:all 0.2s ease;
}

.btn-add{
background:linear-gradient(135deg, var(--gold-dark) 0%, var(--gold) 100%);
color:#000;
}

.btn-add:hover{
transform:translateY(-2px);
box-shadow:0 4px 12px rgba(255, 179, 0, 0.4);
}

.btn-cancel{
background:#e0e0e0;
color:#333;
}

.btn-cancel:hover{
background:#d0d0d0;
}

/* ===== MANDI SIZE MODAL ===== */
.mandi-modal-content{
max-width:350px;
}

.mandi-sizes{
display:grid;
grid-template-columns:repeat(2,1fr);
gap:12px;
margin-top:20px;
}

.mandi-size-btn{
padding:20px 12px;
border:2px solid var(--accent);
border-radius:10px;
background:var(--panel);
color:var(--text);
font-weight:600;
font-size:16px;
cursor:pointer;
transition:all 0.3s ease;
display:flex;
flex-direction:column;
align-items:center;
justify-content:center;
gap:8px;
}

.mandi-size-btn:hover{
background:var(--accent);
color:#000;
transform:translateY(-2px);
box-shadow:0 6px 16px rgba(163, 230, 53, 0.4);
}

.mandi-size-btn:active{
transform:scale(0.97);
}

.size-name{
font-size:16px;
font-weight:700;
}

.size-price{
font-size:18px;
font-weight:bold;
}

.total-section{
flex-shrink:0;
background:linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
color:var(--gold);
padding:8px 10px;
border-radius:8px;
margin-bottom:6px;
margin-top:0;
}

.total{
font-size:20px;
font-weight:bold;
text-align:right;
text-shadow:1px 1px 4px rgba(0,0,0,0.3);
}

.footer{
flex-shrink:0;
text-align:center;
font-size:10px;
color:#666;
border-top:1px dashed #aaa;
margin-top:4px;
padding-top:4px;
}

.footer b{
font-weight:700;
}

.actions{
flex-shrink:0;
display:flex;
gap:8px;
}

.actions button{
flex:1;
padding:10px;
border:none;
border-radius:8px;
font-weight:bold;
font-size:14px;
cursor:pointer;
transition:all 0.3s ease;
-webkit-tap-highlight-color:transparent;
user-select:none;
min-height:44px;
}

.actions button:active{
transform:scale(0.97);
}

.print{
background:linear-gradient(135deg, var(--gold-dark) 0%, var(--gold) 100%);
color:#000;
box-shadow:0 4px 12px rgba(255, 179, 0, 0.4);
}

.print:hover{
transform:translateY(-2px);
box-shadow:0 6px 16px rgba(255, 179, 0, 0.6);
}

.clear{
background:linear-gradient(135deg, #c62828 0%, var(--red) 100%);
color:white;
box-shadow:0 4px 12px rgba(211, 47, 47, 0.4);
}

.clear:hover{
transform:translateY(-2px);
box-shadow:0 6px 16px rgba(211, 47, 47, 0.6);
}

.empty-bill{
text-align:center;
color:#999;
padding:40px 20px;
font-style:italic;
}

/* ===== PRINT – normal page, clean thermal (no dark backgrounds) ===== */
@media print{
@page{
size: auto;
margin: 12px;
}
html, body{
height: auto;
overflow: visible;
margin: 0;
padding: 0;
background: #fff !important;
color: #000 !important;
-webkit-print-color-adjust: exact;
print-color-adjust: exact;
}
*{
margin: 0;
padding: 0;
}
.left,.actions,.header,.add-custom-btn,.add-permanent-btn,.modal,.bill-no-input,.page-footer{display:none !important;}
.print-ok-modal{display:none !important;}
.app-notification{display:none !important;}
.bill .cut-line,.customer-receipt .cut-line{display:none !important;}
.remove-btn, .remove-cell, th:last-child{display:none !important;}
 qty-btn{display:none !important;}
 qty-controls{display:inline !important;}
 qty-display{font-size:9px !important;}

/* Force clean print: white background, black text only (avoids smudged dark blocks on thermal) */
.bill,
.bill *,
.customer-receipt,
.customer-receipt *{
background: transparent !important;
background-image: none !important;
box-shadow: none !important;
text-shadow: none !important;
color: #000 !important;
}
.bill,
.customer-receipt{
background: #fff !important;
}



/* Shared slip size: first and second bill – slightly smaller */
.bill,
.customer-receipt{
width: 65mm !important;
min-width: 65mm !important;
max-width: 65mm !important;
margin-left: auto !important;
margin-right: auto !important;
padding: 6px !important;
box-sizing: border-box !important;
}

/* Slip 1: Kitchen/Bill – prints first */
.bill{
border: none !important;
page-break-after: always !important;
page-break-inside: avoid !important;
font-size: 12px !important;
}
.bill::after{
content: "";
display: block;
height: 2px;
}
.bill-header{
padding-bottom:1px !important;
margin-bottom:1px !important;
border: none !important;
}
.bill-header b{
font-size: 12px !important;
margin:0 !important;
line-height:1.2 !important;
}
.bill-subtitle{
font-size: 9px !important;
margin-top:0 !important;
line-height:1.2 !important;
}
.bill-number{
display:block !important;
font-size: 9px !important;
margin-bottom:0 !important;
line-height:1.2 !important;
}
.bill-number::after{
content: none;
}
.bill-no-display{
display: inline !important;
}
.bill-no-input{
display:none !important;
}
.token-number{
display:block !important;
font-size: 9px !important;
margin-bottom:0 !important;
line-height:1.2 !important;
}
.datetime{
margin-top:1px !important;
font-size: 9px !important;
line-height:1.2 !important;
}
.bill-items{
margin-bottom:1px !important;
flex:none !important;
}
.payment-options{
display: flex !important;
flex-direction: row !important;
flex-wrap: nowrap !important;
align-items: baseline !important;
gap: 2px !important;
margin:0 !important;
padding:0 !important;
line-height:1 !important;
}
.payment-options input{
display:none !important;
}
.payment-options label{
font-size: 9px !important;
margin:0 !important;
display:inline !important;
flex-shrink: 0 !important;
line-height: 1 !important;
}
.payment-options select{
display:inline !important;
border:none !important;
padding:0 !important;
font-size: 9px !important;
font-weight:bold !important;
-webkit-appearance:none !important;
-moz-appearance:none !important;
appearance:none !important;
background: transparent !important;
background-image: none !important;
line-height: 1 !important;
}
.payment-options + .payment-options{
margin-top: -8px !important;
}
table{
margin:0 !important;
background: transparent !important;
border-collapse: collapse;
}
th{
padding:2px 3px !important;
font-size: 11px !important;
line-height:1.2 !important;
background: transparent !important;
border-bottom: 1px solid #000 !important;
font-weight: bold !important;
}
td{
padding:2px 3px !important;
font-size: 11px !important;
line-height:1.2 !important;
background: transparent !important;
border: none !important;
}
.total-section{
margin:4px 0 !important;
padding:2px 0 !important;
background: transparent !important;
border-top: 1px solid #000 !important;
}
.total-section > div{
font-size: 11px !important;
margin:1px 0 !important;
line-height:1.2 !important;
}
.total{
font-size: 14px !important;
margin:0 !important;
line-height:1.2 !important;
font-weight: bold !important;
}

.footer{
margin-top:2px !important;
padding-top:2px !important;
font-size: 9px !important;
line-height:1.2 !important;
}

/* Slip 2: Customer Token – same size as slip 1 */
.customer-receipt{
display: block !important;
background: white !important;
color: black !important;
page-break-before: always !important;
page-break-inside: avoid !important;
font-size: 12px !important;
}
.customer-receipt .bill-header{
padding-bottom: 1px !important;
margin-bottom: 1px !important;
border-bottom: 1px dashed #000 !important;
}
.customer-receipt .bill-header b{
font-size: 12px !important;
line-height: 1.2 !important;
}
.customer-receipt .bill-subtitle{
font-size: 9px !important;
margin-top: 0 !important;
line-height: 1.2 !important;
}
.customer-receipt .token-number{
font-size: 9px !important;
margin-bottom: 0 !important;
line-height: 1.2 !important;
}
.customer-receipt .datetime{
font-size: 9px !important;
margin-top: 1px !important;
line-height: 1.2 !important;
}
.customer-receipt .customer-items{
margin-top: 0 !important;
margin-bottom: 1px !important;
}
.customer-receipt .customer-items .item{
padding: 2px 0 !important;
border-bottom: 1px dashed #000 !important;
font-size: 9px !important;
font-weight: 500 !important;
line-height: 1.2 !important;
}
.customer-receipt .footer{
font-size: 9px !important;
margin-top: 2px !important;
padding-top: 2px !important;
line-height: 1.2 !important;
}
}

/* ===== RESPONSIVE DESIGN ===== */

/* Tablet (iPad, small laptops) */
@media screen and (max-width: 1024px){
.header h1{
font-size:28px;
}
.left{
width:60%;
}
.bill{
width:40%;
}
.menu{
grid-template-columns:repeat(auto-fill,minmax(150px,1fr));
}
}

/* Mobile Landscape & Small Tablets */
@media screen and (max-width: 768px){
.header h1{
font-size:24px;
}
.header h3{
font-size:14px;
}
.header-info{
flex-direction:column;
gap:4px;
}
.location, .owner{
font-size:12px;
}
.container{
flex-direction:column;
}
.left{
width:100%;
flex:1;
min-height:200px;
}
.bill{
width:100%;
flex:1;
min-height:280px;
}
.tabs{
gap:6px;
padding:8px;
}
.tabs button{
padding:10px 8px;
font-size:13px;
}
.menu{
grid-template-columns:repeat(auto-fill,minmax(140px,1fr));
gap:8px;
}
.menu-item{
min-height:90px;
padding:16px 12px;
}
.item-name{
font-size:13px;
}
.item-price{
font-size:16px;
}
}

/* Mobile Portrait */
@media screen and (max-width: 480px){
.header{
padding:12px 8px;
}
.header h1{
font-size:20px;
}
.header h3{
font-size:12px;
}
.header-info{
font-size:10px;
padding:0 10px;
}
.container{
padding:8px;
gap:8px;
}
.left{
height:45vh;
min-height:350px;
}
.bill{
padding:12px;
max-height:65vh;
overflow-y:auto;
}
.bill-items{
max-height:35vh;
}
.tabs{
gap:4px;
padding:6px;
flex-wrap:wrap;
}
.add-to-menu-btn{
padding:10px;
font-size:13px;
margin-bottom:8px;
}
.tabs button{
padding:8px 6px;
font-size:12px;
min-width:80px;
}
.menu{
grid-template-columns:repeat(2, 1fr);
gap:6px;
padding:8px;
}
.menu-item{
min-height:80px;
padding:12px 8px;
}
.item-name{
font-size:12px;
}
.item-price{
font-size:14px;
}
.bill-header b{
font-size:16px;
}
.bill-subtitle{
font-size:12px;
}
.datetime{
font-size:10px;
}
table{
font-size:13px;
}
#billTable, #billTable th, #billTable td{
padding:8px 10px;
font-size:15px !important;
}
#billTable td:first-child,
#billTable td:nth-child(2),
#billTable td:nth-child(3){
font-size:15px !important;
font-weight:600 !important;
}
#billTable td:first-child{
text-align:left;
}
#billTable td:nth-child(2), #billTable td:nth-child(3){
text-align:center;
}
.qty-display{
font-size:15px !important; /* same size as other columns */
font-weight:600 !important;
}
#customerReceipt .customer-items .item, .customer-receipt .item{
font-size:15px !important;
font-weight:600 !important;
}
/* Ensure print output uses readable sizes */
@media print{
  #billTable, #billTable th, #billTable td{font-size:12pt !important;}
  #billTable td:first-child{font-size:12.5pt !important;}
  .qty-display{font-size:13pt !important;}
  .customer-receipt .item{font-size:12pt !important;}
} 
 qty-btn{
width:22px;
height:22px;
font-size:13px;
}
 qty-display{
min-width:22px;
font-size:12px;
}
.remove-btn{
padding:3px 6px;
font-size:10px;
}
.payment-options{
margin-bottom:6px;
}
.payment-options label{
font-size:10px;
}
.payment-options select{
padding:5px 6px;
font-size:11px;
}
.total{
font-size:18px;
}
.actions button{
padding:8px;
font-size:13px;
}
.add-custom-btn{
width:50px;
height:50px;
bottom:15px;
right:15px;
font-size:28px;
}
.modal-content{
width:95%;
padding:20px;
}
.modal-header h2{
font-size:18px;
}
}

/* Large Desktop */
@media screen and (min-width: 1440px){
.container{
max-width:1400px;
margin:0 auto;
}
.header h1{
font-size:36px;
}
.menu{
grid-template-columns:repeat(auto-fill,minmax(200px,1fr));
}
}

/* Ultra-wide screens */
@media screen and (min-width: 1920px){
.container{
max-width:1600px;
}
}

.customer-receipt{
display:none;
background:white;
color:black;
}


.customer-items{
margin-top:12px;
}

.customer-items .item{
padding:6px 0;
border-bottom:1px dashed #ccc;
font-size:13px;
font-weight:500;
}

</style>
</head>

<body>

<header class="header" role="banner">
<h1><span class="brand-s">S</span><span class="brand-amp" style="color:#f5f5f5;">&amp;</span><span class="brand-h">H</span> ARABIAN MANDI RESTAURANT</h1>
<h3>Mandi | Chinese | Tandoori | Meals | Snacks | Biryani</h3>
<p style="margin:2px 0 0;color:#888;font-size:11px;font-style:italic;">Billing Portal</p>
<div class="header-top-row">
<div class="header-icons">
<div class="settings-container">
<button class="settings-btn" id="settingsBtn" title="Settings" aria-label="Settings">Settings</button>
<div class="settings-dropdown" id="settingsDropdown">
<div class="dropdown-user-info" id="dropdownUserInfo">
<span class="dropdown-user-name" id="dropdownUserName">User</span>
</div>
<div class="edit-menu-section">
<button id="editMenuBtn" class="edit-menu-btn" title="Edit Menu">Edit Menu ▼</button>
<div id="editMenuSubmenu" class="edit-menu-submenu">
<button id="addCategoryBtn" class="dropdown-menu-btn" title="Add New Category">Add Category</button>
<button id="deleteCategoryBtn" class="dropdown-menu-btn" title="Delete Category">Delete Category</button>
<button id="addMenuBtn" class="dropdown-menu-btn" title="Add New Menu">Add Menu</button>
<button id="deleteMenuBtn" class="dropdown-menu-btn" title="Delete Menu">Delete Menu</button>
</div>
</div>
<button id="logoutBtn" class="logout-btn" title="Logout">Logout</button>
</div>
</div>
</div>
<div class="analytics-btn-wrapper">
<button class="header-icon-btn" id="analyticsBtn" title="View Analytics" aria-label="View Analytics">Analytics</button>
<button class="header-icon-btn" id="printQueueBtn" title="View Print Queue" aria-label="View Print Queue" style="margin-left: 10px;">Print Queue</button>
</div>
</div>
<div class="header-info">
<div class="location">
<strong>Location:</strong> <span>1st floor opp three temples, Anits road, Sangivalasa,<br>Thagarapuvalasa, Vishakapatnam, AP - 531162</span>
</div>
<div class="owner" style="flex: 1; text-align: right; padding-right: 0px;">
<div style="width:100%; display:flex; flex-wrap:wrap; gap:0; align-items:flex-start; justify-content:flex-end;">
<strong style="margin-right: 6px;">Owner:</strong> <span>A. Santosh Kumar</span>
</div>
<div style="width:100%; display:flex; flex-wrap:wrap; gap:0; align-items:flex-start; justify-content:flex-end; margin-top:4px;">
<strong style="margin-right: 6px;">Contact No:</strong> <span>7569533075, 9703932144</span>
</div>
</div>
</div>
</header>

<main class="container" role="main" aria-label="POS System Interface">

<div class="left">
<div class="tabs" id="tabs"></div>
<div class="menu" id="menu"></div>
</div>

<div class="bill">

<div class="cut-line"></div>

<div class="bill-header">
<div class="bill-number">
Bill No: <span id="billNoDisplay" class="bill-no-display" aria-hidden="false">0</span>
</div>
<b>S&H ARABIAN MANDI RESTAURANT</b><br>
<span class="bill-subtitle">Mandi | Chinese | Tandoori | Meals | Snacks | Biryani</span><br>
<span style="font-size:10px;">Contact No: 7569533075, 9703932144</span>
<div class="datetime">
<span id="date"></span>
<span id="time"></span>
</div>
</div>

<div class="bill-items">
<table id="billTable">
<thead>
<tr><th>Item</th><th>Qty</th><th>Price</th><th>Remove</th></tr>
</thead>
<tbody id="billBody"></tbody>
</table>
</div>

<div class="payment-options">
<label>Table No:</label>
<select id="tableNo">
<option value="">X</option>
<option value="1">Table 1</option>
<option value="2">Table 2</option>
<option value="3">Table 3</option>
<option value="4">Table 4</option>
<option value="5">Table 5</option>
<option value="6">Table 6</option>
<option value="7">Table 7</option>
<option value="8">Table 8</option>
<option value="9">Table 9</option>
<option value="10">Table 10</option>
</select>
</div>

<div class="payment-options">
<label>Payment Method:</label>
<select id="paymentMethod">
<option value="Cash / UPI">Cash / UPI</option>
<option value="Card">Card</option>
</select>
</div>

<div class="payment-options">
<label>Order Type:</label>
<select id="orderType">
<option value="Dine-in / Take Out">Dine-in / Take Out</option>
<option value="Swiggy / Zomato">Swiggy / Zomato</option>
</select>
</div>

<div class="payment-options">
<input type="number" id="discountPercent" min="0" max="100" value="0" placeholder="Discount %" onchange="render()" style="padding:8px;border:1px solid #555;border-radius:6px;background:#2a2a2a;color:#fff;font-size:14px;width:100%;">
</div>

<div class="total-section">
<div style="font-size:14px;margin-bottom:4px;display:flex;justify-content:space-between;"><span>Subtotal:</span><span>&#x20B9;<span id="subtotal">0</span></span></div>
<div style="font-size:14px;margin-bottom:4px;display:flex;justify-content:space-between;color:#ff6b6b;"><span>Discount (<span id="discountPercentDisplay">0</span>%):</span><span>- &#x20B9;<span id="discountAmount">0</span></span></div>
<div class="total">Total: &#x20B9;<span id="total">0</span></div>
</div>

<div class="actions">
<button id="printBtn" class="print" onclick="printReceipt()">Print</button>
<button id="clearBtn" class="clear" onclick="clearBill()">Clear</button>
</div>

<div class="footer" style="margin-top:4px;"><div style="font-size:12px;margin-bottom:2px;">Thank you!</div><b>&copy; ANITS 2023&ndash;2027 CSE 88 DEV</b></div>

<div class="cut-line thermal-cut"></div>

</div>


</main>

<footer class="page-footer" role="contentinfo">
  <b>© ANITS 2023–2027 CSE 88 DEV</b>
</footer>

<!-- Customer Token Receipt -->
<aside class="customer-receipt" id="customerReceipt" role="complementary">

<div class="cut-line"></div>

<div class="bill-header">
<div class="token-number">Token No: <span id="tokenNumber">1</span></div>
<b>SH ARABIAN MANDI RESTAURANT</b><br>
<span class="bill-subtitle">Mandi | Chinese | Tandoori | Meals | Snacks | Biryani</span><br>
<span style="font-size:10px;">Contact No: 7569533075, 9703932144</span>
<div class="datetime">
<span id="dateCustomer"></span>
<span id="timeCustomer"></span>
</div>
</div>

<div class="customer-items" id="customerItems"></div>

<div class="footer" style="margin-top:6px;"><div style="font-size:12px;margin-bottom:2px;">Thank you!</div><b>© ANITS 2023–2027 CSE 88 DEV</b></div>

<div class="cut-line thermal-cut"></div>

</aside>

<!-- Add Custom Item Button -->
<button class="add-custom-btn" onclick="openCustomModal()" title="Add Custom Item">+</button>

<!-- Custom Item Modal -->
<div class="modal" id="customModal">
<div class="modal-content">
<div class="modal-header">
<h2>Add Custom Item</h2>
<button class="modal-close" onclick="closeCustomModal()">×</button>
</div>
<form onsubmit="addCustomItem(event)">
<div class="form-group">
<label for="customItemName">Item Name *</label>
<input type="text" id="customItemName" placeholder="e.g., Special Thali" required>
</div>
<div class="form-group">
<label for="customItemPrice">Price (&#x20B9;) *</label>
<input type="number" id="customItemPrice" placeholder="e.g., 150" min="1" required>
</div>
<div class="modal-actions">
<button type="button" class="btn-cancel" onclick="closeCustomModal()">Cancel</button>
<button type="submit" class="btn-add">Add to Bill</button>
</div>
</form>
</div>
</div>


<!-- Add Category Modal -->
<div class="modal" id="addCategoryModal">
<div class="modal-content">
<div class="modal-header">
<h2>Add New Category</h2>
<button class="modal-close" onclick="closeAddCategoryModal()">×</button>
</div>
<form onsubmit="submitAddCategory(event)">
<div class="form-group">
<label for="newCategoryName">Category Name *</label>
<input type="text" id="newCategoryName" placeholder="e.g., Desserts" required>
</div>
<div class="modal-actions">
<button type="button" class="btn-cancel" onclick="closeAddCategoryModal()">Cancel</button>
<button type="submit" class="btn-add">Add Category</button>
</div>
</form>
</div>
</div>

<!-- Delete Category Modal -->
<!-- Add Menu Modal -->
<div class="modal" id="permanentModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Add Menu Item</h2>
      <button class="modal-close" onclick="closePermanentModal()">×</button>
    </div>
    <div class="add-menu-tabs">
      <button id="addSingleTab" class="add-menu-tab active" type="button">Single Item</button>
      <button id="addGroupTab" class="add-menu-tab" type="button">Group Item</button>
    </div>
    <div id="addMenuFormContainer"></div>
    <!-- Removed duplicate add-menu-tabs and addMenuFormContainer -->
  </div>
</div>
<div class="modal" id="deleteCategoryModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Delete Category</h2>
      <button class="modal-close" onclick="closeDeleteCategoryModal()">×</button>
    </div>
    <form id="deleteCategoryForm" onsubmit="submitDeleteCategory(event)">
      <div class="form-group">
        <label for="categoryToDelete">Select Category to Delete *</label>
        <select id="categoryToDelete" required>
          <option value="">-- Select Category --</option>
        </select>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn-cancel" onclick="closeDeleteCategoryModal()">Cancel</button>
        <button type="submit" class="btn-add" style="background: #C62828; color: #fff;">Delete</button>
      </div>
    </form>
  </div>
</div>

<!-- Delete Menu Modal -->
<div class="modal" id="deleteMenuModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Delete Menu Item</h2>
      <button class="modal-close" onclick="closeDeleteMenuModal()">×</button>
    </div>
    <form id="deleteMenuForm" onsubmit="submitDeleteMenu(event)">
      <div class="form-group">
        <label for="itemToDelete">Select Item to Delete *</label>
        <select id="itemToDelete" required>
          <option value="">-- Select Item --</option>
        </select>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn-cancel" onclick="closeDeleteMenuModal()">Cancel</button>
        <button type="submit" class="btn-add" style="background: #C62828; color: #fff;">Delete</button>
      </div>
    </form>
  </div>
</div>

<style>
.add-menu-tab {
  flex:1;
  background:#f3f4f6;
  border:1px solid #d1d5db;
  border-radius:6px 6px 0 0;
  color:#111;
  font-weight:600;
  font-size:15px;
  padding:10px 0;
  cursor:pointer;
  transition:background 0.2s, color 0.2s, border-color 0.2s;
  opacity: 1 !important;
  pointer-events: auto !important;
}
.add-menu-tab.active {
  background:var(--accent);
  color:#000;
  border-color:var(--accent);
  opacity: 1 !important;
}
</style>
<script>
// HTML for single and group item forms
const singleItemFormHTML = `
  <form id="permanentItemForm" onsubmit="addPermanentItem(event)">
    <div class="form-group">
      <label for="permanentItemName">Item Name *</label>
      <input type="text" id="permanentItemName" name="name" placeholder="e.g., Special Manchurian" required>
    </div>
    <div class="form-group">
      <label for="permanentItemPrice">Price (&#x20B9;) *</label>
      <input type="number" id="permanentItemPrice" name="price" placeholder="e.g., 150" min="1" required>
    </div>
    <div class="form-group">
      <label for="permanentItemCategory">Category *</label>
      <select id="permanentItemCategory" name="category" required>
        <!-- Categories will be populated dynamically -->
      </select>
    </div>
    <div class="form-group">
    </div>
    <div class="form-group">
      <label for="permanentItemImageUrl">Image URL (Optional)</label>
      <input type="url" id="permanentItemImageUrl" name="image_url" placeholder="https://example.com/image.jpg">
      <small style="color: #999; margin-top: 4px; display: block;">Paste a full image URL</small>
      <div id="permanentItemPreview" class="image-preview" style="margin-top:8px;"></div>
    </div>
    <div class="modal-actions">
      <button type="button" class="btn-cancel" onclick="closePermanentModal()">Cancel</button>
      <button type="submit" class="btn-add">Add to Menu</button>
    </div>
  </form>
`;
// Removed extra Single Item button below Cancel
const groupItemFormHTML = `
  <form id="permanentItemForm" onsubmit="addPermanentItem(event)">
    <div class="form-group">
      <label for="groupItemName">Item Name *</label>
      <input type="text" id="groupItemName" name="name" placeholder="e.g., Mandi" required>
    </div>
    <div class="form-group">
      <label for="groupItemCategory">Category *</label>
      <select id="groupItemCategory" name="category" required></select>
    </div>
    <div class="form-group">
      <label>Prices *</label>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <input type="number" id="groupPriceSolo" name="price_solo" placeholder="Solo &#x20B9;" min="1" style="width:80px;" required>
        <input type="number" id="groupPriceDuo" name="price_duo" placeholder="Duo &#x20B9;" min="1" style="width:80px;" required>
        <input type="number" id="groupPriceTrio" name="price_trio" placeholder="Trio &#x20B9;" min="1" style="width:80px;" required>
        <input type="number" id="groupPriceSquad" name="price_squad" placeholder="Squad &#x20B9;" min="1" style="width:80px;" required>
        </div>
      </div>
      <div class="form-group">
        <label for="groupItemImageUrl">Image URL (Optional)</label>
        <input type="url" id="groupItemImageUrl" name="image_url" placeholder="https://example.com/image.jpg">
        <small style="color: #999; margin-top: 4px; display: block;">Paste a full image URL</small>
        <div id="groupItemPreview" class="image-preview" style="margin-top:8px;"></div>
      </div>
      <div class="modal-actions">
      <button type="button" class="btn-cancel" onclick="closePermanentModal()">Cancel</button>
      <button type="submit" class="btn-add">Add to Menu</button>
    </div>
  </form>
`;

function renderAddMenuForm(tab) {
  const container = document.getElementById('addMenuFormContainer');
  container.innerHTML = tab === 'single' ? singleItemFormHTML : groupItemFormHTML;
  if(tab === 'group') {
    populateGroupMenuCategoryDropdown();
  } else {
    // Always populate the single item category dropdown as well
    if (typeof populateAddMenuCategoryDropdown === 'function') {
      populateAddMenuCategoryDropdown();
    }
  }
}
// Ensure categories are loaded on page load
document.addEventListener('DOMContentLoaded', () => {
  loadCategories();
});
function showAddMenuTab(tab) {
  document.getElementById('addSingleTab').classList.toggle('active', tab === 'single');
  const groupTab = document.getElementById('addGroupTab');
  groupTab.classList.toggle('active', tab === 'group');
  groupTab.style.display = 'block';
  groupTab.disabled = false;
  renderAddMenuForm(tab);
  setTimeout(() => {
    if(tab === 'single') document.getElementById('permanentItemName').focus();
    else document.getElementById('groupItemName').focus();
  }, 100);
}

// Populate group category dropdown as well
function populateGroupMenuCategoryDropdown(){
  const select = document.getElementById("groupItemCategory");
  const currentValue = select.value;
  select.innerHTML = '';
  Object.keys(data).forEach(cat => {
    const option = document.createElement("option");
    option.value = cat;
    option.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
    select.appendChild(option);
  });
  if(currentValue && data[currentValue]){
    select.value = currentValue;
  } else if(Object.keys(data).length > 0){
    select.value = Object.keys(data)[0];
  }
}

// openPermanentModal is defined later with admin check; it also handles tabs.

document.getElementById('addSingleTab').onclick = function() {
  window.lastAddMenuTab = 'single';
  showAddMenuTab('single');
};
document.getElementById('addGroupTab').onclick = function() {
  window.lastAddMenuTab = 'group';
  showAddMenuTab('group');
};
</script>
<div class="modal" id="mandiSizeModal">
<div class="modal-content mandi-modal-content">
<div class="modal-header">
<h2 id="mandiItemTitle">Select Size</h2>
<button class="modal-close" onclick="closeMandiSizeModal()">×</button>
</div>
<div class="mandi-sizes">
<button class="mandi-size-btn" onclick="selectMandiSize('solo')">
<div class="size-name">Solo</div>
<div class="size-price">&#x20B9;<span id="soloPrice">220</span></div>
</button>
<button class="mandi-size-btn" onclick="selectMandiSize('duo')">
<div class="size-name">Duo</div>
<div class="size-price">&#x20B9;<span id="duoPrice">380</span></div>
</button>
<button class="mandi-size-btn" onclick="selectMandiSize('trio')">
<div class="size-name">Trio</div>
<div class="size-price">&#x20B9;<span id="trioPrice">599</span></div>
</button>
<button class="mandi-size-btn" onclick="selectMandiSize('squad')">
<div class="size-name">Squad</div>
<div class="size-price">&#x20B9;<span id="squadPrice">899</span></div>
</button>
</div>
</div>
</div>

<!-- Beverage Size Selection Modal -->
<div class="modal" id="beverageSizeModal">
<div class="modal-content mandi-modal-content">
<div class="modal-header">
<h2 id="beverageItemTitle">Select Size</h2>
<button class="modal-close" onclick="closeBeverageSizeModal()">×</button>
</div>
<div class="mandi-sizes">
<button class="mandi-size-btn" onclick="selectBeverageSize('2L')">
<div class="size-name">2 L</div>
<div class="size-price">&#x20B9;<span id="price2L">100</span></div>
</button>
<button class="mandi-size-btn" onclick="selectBeverageSize('1L')">
<div class="size-name">1 L</div>
<div class="size-price">&#x20B9;<span id="price1L">50</span></div>
</button>
<button class="mandi-size-btn" onclick="selectBeverageSize('750ml')">
<div class="size-name">750 ml</div>
<div class="size-price">&#x20B9;<span id="price750ml">40</span></div>
</button>
<button class="mandi-size-btn" onclick="selectBeverageSize('250ml')">
<div class="size-name">250 ml</div>
<div class="size-price">&#x20B9;<span id="price250ml">20</span></div>
</button>
<button class="mandi-size-btn" onclick="selectBeverageSize('250ml_glass')">
<div class="size-name">250 ml (Glass Bottle)</div>
<div class="size-price">&#x20B9;<span id="price250ml_glass">10</span></div>
</button>
</div>
</div>
</div>

<!-- Print Queue Modal -->
<div class="modal" id="printQueueModal">
<div class="modal-content" style="max-width: 800px;">
<div class="modal-header">
<h2>Print Queue - Pending Requests</h2>
<button class="modal-close" onclick="closePrintQueueModal()">×</button>
</div>
<div id="printQueueList" style="max-height: 500px; overflow-y: auto; padding: 10px;">
<p style="text-align: center; color: var(--muted);">Loading...</p>
</div>
</div>
</div>

<script>
// Connect to local backend
const apiUrl = (path) => 'https://sh-amr-backend.onrender.com' + path;

// ===== AUTHENTICATION CHECK =====
function checkAuthentication() {
	const token = localStorage.getItem('authToken');
	const user = localStorage.getItem('user');
	
	if (!token || !user) {
		// Redirect to login if not authenticated
		window.location.href = '/login.html';
		return false;
	}
	
	try {
		const userData = JSON.parse(user);
		displayUserInfo(userData);
    // If a waiter accidentally navigated to the main interface, redirect to server index
    if (userData && userData.role === 'waiter') {
      window.location.href = '/server-index.html';
      return false;
    }
	} catch (e) {
		localStorage.removeItem('authToken');
		localStorage.removeItem('user');
		window.location.href = '/login.html';
	}
	
	return true;
}

function displayUserInfo(user) {
	const userDisplay = document.getElementById('userDisplay');
	const dropdownUserName = document.getElementById('dropdownUserName');
	if (user) {
		const capitalizedName = user.username.charAt(0).toUpperCase() + user.username.slice(1);
		if (userDisplay) {
			userDisplay.textContent = `${capitalizedName}`;
		}
		if (dropdownUserName) {
			dropdownUserName.textContent = `${capitalizedName}`;
		}
	}
}

function setupLogout() {
	const logoutBtn = document.getElementById('logoutBtn');
	if (logoutBtn) {
		logoutBtn.addEventListener('click', function() {
			localStorage.removeItem('authToken');
			localStorage.removeItem('user');
			window.location.href = '/login.html';
		});
	}
}

function setupSettingsDropdown() {
	const settingsBtn = document.getElementById('settingsBtn');
	const settingsDropdown = document.getElementById('settingsDropdown');
	const addMenuBtn = document.getElementById('addMenuBtn');
	const addCategoryBtn = document.getElementById('addCategoryBtn');
	const deleteMenuBtn = document.getElementById('deleteMenuBtn');
	
	// Toggle dropdown on settings button click
	if (settingsBtn) {
		settingsBtn.addEventListener('click', function(e) {
			e.stopPropagation();
			settingsDropdown.classList.toggle('active');
		});
	}
	
	// Close dropdown when clicking outside
	document.addEventListener('click', function() {
		if (settingsDropdown.classList.contains('active')) {
			settingsDropdown.classList.remove('active');
		}
	});
	
	// Edit Menu button toggle functionality
	const editMenuBtn = document.getElementById('editMenuBtn');
	const editMenuSubmenu = document.getElementById('editMenuSubmenu');
	const deleteCategoryBtn = document.getElementById('deleteCategoryBtn');
	
	if (editMenuBtn) {
		editMenuBtn.addEventListener('click', function(e) {
			e.stopPropagation();
			editMenuSubmenu.classList.toggle('active');
		});
	}
	
	// Add Category button functionality
	if (addCategoryBtn) {
		addCategoryBtn.addEventListener('click', function() {
			settingsDropdown.classList.remove('active');
			openAddCategoryModal();
		});
	}
	
	// Delete Category button functionality
	if (deleteCategoryBtn) {
		deleteCategoryBtn.addEventListener('click', function() {
			settingsDropdown.classList.remove('active');
			openDeleteCategoryModal();
		});
	}
	
	// Add Menu button functionality
	if (addMenuBtn) {
		addMenuBtn.addEventListener('click', function() {
			settingsDropdown.classList.remove('active');
			openPermanentModal();
		});
	}
	
	// Delete Menu button functionality
	if (deleteMenuBtn) {
		deleteMenuBtn.addEventListener('click', function() {
			settingsDropdown.classList.remove('active');
			openDeleteMenuModal();
		});
	}
}

function isAdminUser() {
  const userData = localStorage.getItem('user');
  if (!userData) return false;
  try {
    const user = JSON.parse(userData);
    return user.role === 'admin';
  } catch (e) {
    return false;
  }
}

function adjustAdminOnlyUI() {
  const addMenuDropdownBtn = document.getElementById('addMenuBtn');
  const addCategoryBtn = document.getElementById('addCategoryBtn');
  const deleteMenuBtn = document.getElementById('deleteMenuBtn');
  const deleteCategoryBtn = document.getElementById('deleteCategoryBtn');
  const editMenuSection = document.querySelector('.edit-menu-section');
  const analyticsBtn = document.getElementById('analyticsBtn');
  const printQueueBtn = document.getElementById('printQueueBtn');
  
  if (!isAdminUser()) {
    if (addMenuDropdownBtn) addMenuDropdownBtn.style.display = 'none';
    if (addCategoryBtn) addCategoryBtn.style.display = 'none';
    if (deleteMenuBtn) deleteMenuBtn.style.display = 'none';
    if (deleteCategoryBtn) deleteCategoryBtn.style.display = 'none';
    if (editMenuSection) editMenuSection.style.display = 'none';
    // Hide analytics for non-admin users
    if (analyticsBtn) analyticsBtn.style.display = 'none';
  } else {
    if (analyticsBtn) analyticsBtn.style.display = '';
    // Ensure only one event handler is attached
    analyticsBtn.replaceWith(analyticsBtn.cloneNode(true));
    const newAnalyticsBtn = document.getElementById('analyticsBtn');
    newAnalyticsBtn.addEventListener('click', function() {
      console.log('Analytics button clicked');
      window.location.href = 'analytics.html';
    });
    newAnalyticsBtn.style.cursor = 'pointer';
  }

  // Print queue should be visible only to admin and cashier
  const userData = localStorage.getItem('user');
  let role = null;
  try {
    role = userData ? JSON.parse(userData).role : null;
  } catch (e) {
    role = null;
  }
  if (printQueueBtn && role !== 'admin' && role !== 'cashier') {
    printQueueBtn.style.display = 'none';
  }
}

function normalizeCategory(category) {
  return (category || '').toString().trim().toLowerCase() || 'mandi';
}

// Check authentication on page load
document.addEventListener('DOMContentLoaded', async function() {
	if (checkAuthentication()) {
		setupLogout();
		setupSettingsDropdown();
    adjustAdminOnlyUI();
		// Load categories first, then custom menu items from database
    await loadCategories();
    await loadCustomMenuItems();
    // Rebuild category tabs after loading categories and items
    if (typeof tabsDiv !== 'undefined') {
      tabsDiv.innerHTML = '';
      Object.keys(data).forEach((cat,i)=>{
        let btn=document.createElement("button");
        btn.innerText=cat;
        if(i===0)btn.classList.add("active");
        btn.onclick=()=>{
          document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
          btn.classList.add("active");
          load(cat);
        };
        tabsDiv.appendChild(btn);
      });
    }
    // Populate Add Menu category dropdown after data is loaded
    if(document.getElementById("permanentItemCategory")){
        populateAddMenuCategoryDropdown();
    }
	}
});

/* ===== FULL DISH LIST WITH IMAGES ===== */
const data = {

};


/* ===== ELEMENTS ===== */
const tabsDiv=document.getElementById("tabs");
const menuDiv=document.getElementById("menu");
const billBody=document.getElementById("billBody");
const customerItems=document.getElementById("customerItems");

let cart={}, total=0;
let billNumber=0; // last assigned token on server (0 if none)
let displayToken=0; // what to show in UI (next available or reserved)
let isTokenReserved = false; // true when this client has reserved/been assigned a token
let isTransferredBill = false;  // Track if current bill is from transfer (don't increment counter)
let isLoadingBillNo = false;
let lastBillDate = localStorage.getItem('lastBillDate');

/* CHECK IF DATE HAS CHANGED FOR 24-HOUR RESET */
function checkDateChangeAndReset() {
  const today = new Date().toDateString();
  const storedDate = localStorage.getItem('lastBillDate');
  
  if (storedDate !== today) {
    // Date has changed - reset bill number to start from backend
    localStorage.setItem('lastBillDate', today);
    localStorage.removeItem('billNumber');
    return true;
  }
  return false;
}

/* FETCH BILL NUMBER FROM DATABASE */
async function fetchNextBillNumber() {
  if (isLoadingBillNo) return;
  isLoadingBillNo = true;
  
  try {
    const response = await fetch(apiUrl('/api/token'));
    const data = await response.json();
    if (data.success) {
      // /api/token returns a newly incremented token
      billNumber = data.token;
      displayToken = billNumber; // reserved/assigned token should be shown
      isTokenReserved = true; // we reserved this token
      localStorage.setItem('billNumber', billNumber);
      updateBillToken();
    }
  } catch (error) {
  } finally {
    isLoadingBillNo = false;
  }
}

/* INITIALIZE BILL NUMBER ON PAGE LOAD */
async function loadNumbers(){
  // Check if 24 hours have passed
  const dateChanged = checkDateChangeAndReset();
  
  try {
    // Always fetch current bill from database to sync
    const response = await fetch(apiUrl('/api/token/current'));
    const data = await response.json();
    
    if(data.success){
      // /api/token/current returns the last assigned token; display the next available
      billNumber = data.token;
      displayToken = (billNumber || 0) + 1;
      localStorage.setItem('billNumber', billNumber);
      localStorage.setItem('lastBillDate', new Date().toDateString());
      updateBillToken();
    }
  } catch (error) {
    // Fallback to stored value or 0
    const stored = localStorage.getItem('billNumber');
    billNumber = stored ? parseInt(stored) : 0;
    displayToken = (billNumber || 0) + 1;
    updateBillToken();
  }
}

/* UPDATE BILL AND TOKEN NUMBERS */
function updateBillToken(){
  const billNoElement = document.querySelector('.bill-header .bill-number');
  if(billNoElement) billNoElement.setAttribute('data-bill-no', displayToken);
  const displayEl = document.getElementById("billNoDisplay");
  if(displayEl) displayEl.textContent = displayToken;
  const tokenEl = document.getElementById("tokenNumber");
  if(tokenEl) tokenEl.innerText = displayToken;
}

/* NEW BILL LISTENER - Auto-fetch next number */
async function startNewBill() {
  if(Object.keys(cart).length > 0){
    if(confirm("Start a new bill?")){
      cart = {};
      document.getElementById("discountPercent").value = 0;
      await fetchNextBillNumber();
      render();
    }
  } else {
    await fetchNextBillNumber();
  }
}

/* MANUAL INPUT LISTENER */
document.addEventListener('DOMContentLoaded', function(){
  loadNumbers();
});

/* DATE TIME */
function updateDateTime(){
const now=new Date();
const dateStr="Date: "+now.toLocaleDateString();
const timeStr="Time: "+now.toLocaleTimeString();
date.innerText=dateStr;
time.innerText=timeStr;
dateCustomer.innerText=dateStr;
timeCustomer.innerText=timeStr;
}
setInterval(updateDateTime,1000);
updateDateTime();

/* AUTO-REFRESH PRINT QUEUE EVERY 5 SECONDS IF MODAL IS OPEN */
setInterval(() => {
  const modal = document.getElementById("printQueueModal");
  if(modal && modal.classList.contains("active")){
    loadPrintQueue();
  }
}, 5000);

/* AUTO-REFRESH BILL NUMBER EVERY 10 SECONDS (NO INCREMENT) */
async function refreshBillNumberIfIdle(){
  if(isLoadingBillNo) return;
  if(typeof isPrinting !== 'undefined' && isPrinting) return;

  try {
    const response = await fetch(apiUrl('/api/token/current'));
    const data = await response.json();
    if(data.success){
      billNumber = data.token;
      localStorage.setItem('billNumber', billNumber);
      localStorage.setItem('lastBillDate', new Date().toDateString());
      // Only update the displayed token when we don't currently hold a reserved token
      if(!isTokenReserved){
        displayToken = (billNumber || 0) + 1;
        updateBillToken();
      }
    }
  } catch (error) {
  }
}

setInterval(() => {
  refreshBillNumberIfIdle();
}, 10000);

/* TABS */
Object.keys(data).forEach((cat,i)=>{
let btn=document.createElement("button");
btn.innerText=cat;
if(i===0)btn.classList.add("active");
btn.onclick=()=>{
document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
btn.classList.add("active");
load(cat);
};
tabsDiv.appendChild(btn);
});

/* LOAD MENU */
function load(cat){
menuDiv.innerHTML = "";
console.log('Loading category:', cat, 'Items:', data[cat]);
if (!data[cat] || !Array.isArray(data[cat])) {
  console.warn('Category data missing or not an array for:', cat, data[cat]);
  return;
}
data[cat].forEach(item=>{
let card=document.createElement("div");
card.className="menu-item";
let imageUrl = null;

  // Handle group items with size selection (including mandi)
  if(cat !== "beverages" && typeof item === 'object' && item.prices){
  card.onclick=()=>showMandiSizeModal(item);
  const displayName = item.name || 'Unnamed';
  const soloP = (item.prices && (typeof item.prices.solo === 'number')) ? item.prices.solo : (item.prices && item.prices.solo ? item.prices.solo : 0);
  const squadP = (item.prices && (typeof item.prices.squad === 'number')) ? item.prices.squad : (item.prices && item.prices.squad ? item.prices.squad : soloP);
  card.innerHTML=`
  <div class="item-name">${displayName}</div>
  <div class="item-price">\u20B9${soloP} - \u20B9${squadP}</div>
  `;
  
  if(item.image){
    imageUrl = item.image;
  }
} else if(cat === "beverages" && typeof item === 'object' && item.prices){
  // Handle beverage items with size selection
  card.onclick=()=>showBeverageSizeModal(item);
  const priceValues = Object.values(item.prices);
  card.innerHTML=`
  <div class="item-name">${item.name}</div>
  <div class="item-price">\u20B9${Math.min(...priceValues)} - \u20B9${Math.max(...priceValues)}</div>
  `;
  
  if(item.image){
    imageUrl = item.image;
  }
} else {
  // Handle other items (array format)
  console.log('Item array format:', item[0], 'Price:', item[1], 'ImageURL:', item[2]);
  card.onclick=()=>add(item[0],item[1]);
  card.innerHTML=`
  <div class="item-name">${item[0]}</div>
  <div class="item-price">\u20B9${item[1]}</div>
  ${item[3] ? `<div class='item-table-no'>Table No: ${item[3]}</div>` : ''}
  `;

  if(item[2] && item[2] !== ""){
    imageUrl = item[2];
    console.log('Found image URL in item[2]:', imageUrl);
  }
}

if(!imageUrl || imageUrl === ""){
  console.log('No image URL for item:', typeof item === 'object' ? item.name : item[0]);
  imageUrl = null;
}

if(imageUrl){
  const itemNameForLog = (typeof item === 'object') ? (item.name || item[0]) : item[0];
  console.log(`Attempting to set background image for ${itemNameForLog}:`, imageUrl.slice(0,100) + (imageUrl.length>100 ? '...[truncated]' : ''));
  // Preload to ensure image is reachable and valid before applying as background
  const testImg = new Image();
  testImg.onload = function(){
    card.style.backgroundImage = `url('${imageUrl}')`;
    card.style.backgroundSize = 'cover';
    card.style.backgroundPosition = 'center';
    card.style.backgroundRepeat = 'no-repeat';
    card.setAttribute('data-has-image', 'true');
  };
  testImg.onerror = function(){
    console.error(`Failed to load image for ${itemNameForLog}:`, imageUrl);
    card.style.backgroundImage = 'none';
    card.removeAttribute('data-has-image');
    // Optionally show a subtle placeholder class
    card.classList.add('image-load-failed');
  };
  // Trigger load
  testImg.src = imageUrl;
}else{
  card.style.backgroundImage='none';
  card.removeAttribute('data-has-image');
}

menuDiv.appendChild(card);
});
}
load(Object.keys(data)[0]);

/* BILLING */
function add(n,p){
cart[n]?cart[n].qty++:cart[n]={price:p,qty:1};
render();
}

function render(){
billBody.innerHTML="";
customerItems.innerHTML="";
let subtotal=0;

if(Object.keys(cart).length === 0){
billBody.innerHTML='<tr><td colspan="4" class="empty-bill">No items added yet</td></tr>';
}else{
for(let k in cart){
let r=billBody.insertRow(-1);
r.insertCell(0).innerText=k;

// Quantity controls
let qtyCell=r.insertCell(1);
qtyCell.className="qty-cell";
let qtyControls=document.createElement("div");
qtyControls.className="qty-controls";
qtyControls.innerHTML=`
<button class="qty-btn" onclick="decreaseQty('${k.replace(/'/g, "\\'")}')">&minus;</button>
<span class="qty-display">${cart[k].qty}</span>
<button class="qty-btn" onclick="increaseQty('${k.replace(/'/g, "\\'")}')">+</button>
`;
qtyCell.appendChild(qtyControls);
r.insertCell(2).innerText = '\u20B9' + (cart[k].price * cart[k].qty);
subtotal+=cart[k].price*cart[k].qty;

// Add remove button
let removeCell=r.insertCell(3);
removeCell.className="remove-cell";
let removeBtn=document.createElement("button");
removeBtn.className="remove-btn";
removeBtn.innerText="✕";
removeBtn.onclick=()=>removeItem(k);
removeCell.appendChild(removeBtn);

// Add to customer receipt (just item names)
let itemDiv=document.createElement("div");
itemDiv.className="item";
itemDiv.innerText=cart[k].qty+" x "+k;
customerItems.appendChild(itemDiv);
}
}

// Calculate discount
const discountPercent = parseFloat(document.getElementById("discountPercent")?.value || 0);
const discountAmount = Math.round((subtotal * discountPercent) / 100);
total = subtotal - discountAmount;

// Update displays
document.getElementById("subtotal").innerText=subtotal;
document.getElementById("discountPercentDisplay").innerText=discountPercent;
document.getElementById("discountAmount").innerText=discountAmount;
document.getElementById("total").innerText=total;

// Hide discount section if no discount is given
const discountSection = document.querySelector('.total-section > div:nth-child(2)');
if(discountSection){
  discountSection.style.display = discountPercent > 0 ? 'flex' : 'none';
}

// Keep table number section visible
// update action buttons state
updateActionButtons();
}

function updateActionButtons(){
	const printBtn = document.getElementById('printBtn');
	const clearBtn = document.getElementById('clearBtn');
	const hasItems = Object.keys(cart).length>0 && total>0;
	if(printBtn) printBtn.disabled = !hasItems;
	if(clearBtn) clearBtn.disabled = !Object.keys(cart).length>0;
	// visual disabled styling
	if(printBtn) printBtn.style.opacity = printBtn.disabled ? '0.6' : '1';
	if(clearBtn) clearBtn.style.opacity = clearBtn.disabled ? '0.6' : '1';
}

function increaseQty(itemName){
if(cart[itemName]){
cart[itemName].qty++;
render();
}
}

function decreaseQty(itemName){
if(cart[itemName]){
if(cart[itemName].qty > 1){
cart[itemName].qty--;
render();
}else{
// If quantity is 1, remove the item
removeItem(itemName);
}
}
}

function removeItem(itemName){
delete cart[itemName];
render();
}

async function clearBill(){
  if(Object.keys(cart).length > 0){
    if(confirm("Clear all items?")){
      cart={};
      document.getElementById("discountPercent").value = 0;
      render();
    }
  }
}

// Print lock to prevent rapid double-printing on mobile
let isPrinting = false;

// Hide empty fields before printing
function hideEmptyFieldsBeforePrint(){
  // Hide discount row if no discount
  const discountPercent = parseFloat(document.getElementById("discountPercent")?.value || 0);
  const discountLine = document.querySelector('.total-section > div:nth-child(2)');
  if(discountLine){
    discountLine.style.display = discountPercent > 0 ? 'flex' : 'none';
  }
  
  // Hide table number if not selected
  const tableNo = document.getElementById("tableNo")?.value;
  const tableSection = Array.from(document.querySelectorAll('.payment-options')).find(el => 
    el.querySelector('label') && el.querySelector('label').textContent.includes('Table')
  );
  if(tableSection){
    tableSection.style.display = tableNo ? 'flex' : 'none';
  }
  // Also remove any table info from customer receipt area to prevent duplication on print
  const customerReceiptTable = document.querySelector('#customerReceipt .table-info');
  if(customerReceiptTable){
    customerReceiptTable.style.display = tableNo ? 'block' : 'none';
  }
}

function printReceipt(){
// Prevent multiple rapid print calls (solves mobile second-print issue)
if(isPrinting){
  return;
}

proceedWithPrint();

async function proceedWithPrint(){
// require positive total to avoid printing zero receipts
if(Object.keys(cart).length > 0 && total > 0){
  isPrinting = true;

  // Only get new bill number if this is a custom bill (not transferred)
  if(!isTransferredBill){
    try {
      const response = await fetch(apiUrl('/api/token'));
      const data = await response.json();
      if(data.success){
        billNumber = data.token;
        displayToken = billNumber; // reserved token
        isTokenReserved = true;
        updateBillToken();
      } else {
        alert('Error getting bill number. Please try again.');
        isPrinting = false;
        return;
      }
    } catch(error) {
      alert('Error getting bill number: ' + error.message);
      isPrinting = false;
      return;
    }
  }

// Calculate discount for bill data
let subtotal = 0;
for(let k in cart){
  subtotal += cart[k].price * cart[k].qty;
}
const discountPercent = parseFloat(document.getElementById("discountPercent")?.value || 0);
const discountAmount = Math.round((subtotal * discountPercent) / 100);
const finalTotal = subtotal - discountAmount;

// Prepare bill data with current bill number
const billData = {
items: Object.entries(cart).map(([name, item]) => ({
name: name,
price: item.price,
qty: item.qty
})),
subtotal: subtotal,
// include discount only when > 0
// discount and discountAmount will be added conditionally below
total: finalTotal,
payment: document.getElementById("paymentMethod").value,
orderType: document.getElementById("orderType").value,
// tableNo included only if selected
token: billNumber
};

const tableNoValue = document.getElementById("tableNo")?.value || "";
if (tableNoValue) billData.tableNo = tableNoValue;
const discountPercentValue = parseFloat(document.getElementById("discountPercent")?.value || 0);
if (discountPercentValue > 0) {
  billData.discount = discountPercentValue;
  billData.discountAmount = Math.round((subtotal * discountPercentValue) / 100);
}

if(!billData.token || billData.token === 0) {
  alert('Error: Invalid bill number. Please try again.');
  isPrinting = false;
  return;
}

if(!billData.payment) {
  alert('Error: Please select a payment method.');
  isPrinting = false;
  return;
}

if(!billData.orderType) {
  alert('Error: Please select an order type.');
  isPrinting = false;
  return;
}

// Save bill to database and THEN print
fetch(apiUrl('/api/bill'), {
method: 'POST',
headers: {
'Content-Type': 'application/json'
},
body: JSON.stringify(billData)
})
.then(response => {
  if(!response.ok) {
    throw new Error(`HTTP error! status: ${response.status}`);
  }
  return response.json();
})
.then(data => {
  if(data.success) {
    // Bill saved successfully - proceed with printing
    // Note: Admin bills do NOT go to print queue, only server bills do
    console.log('✅ Bill saved successfully - Bill #' + billNumber);
    
    // Proceed with printing
    function cleanupAfterPrint(){
      // Reset bill number and transfer flag for next transaction
      billNumber = 0;
      displayToken = 1; // show next default until refreshed from server
      isTokenReserved = false;
      updateBillToken();
      isTransferredBill = false;
      
      // Restore visibility of all fields for next bill
      const discountLine = document.querySelector('.total-section > div:nth-child(2)');
      if(discountLine) discountLine.style.display = 'flex';
      const tableSection = Array.from(document.querySelectorAll('.payment-options')).find(el => 
        el.querySelector('label') && el.querySelector('label').textContent.includes('Table')
      );
      if(tableSection) tableSection.style.display = 'flex';
      
      window.removeEventListener('afterprint', cleanupAfterPrint);
      isPrinting = false;  // Release print lock after print completes
      // show OK popup after print completes (short delay to avoid race with dialogs)
      schedulePrintOkPopup(500);
      // Fetch next available bill number for display
      fetch(apiUrl('/api/token/current'))
        .then(r => r.json())
        .then(data => {
          if(data.success){
            billNumber = data.token;
            displayToken = (billNumber || 0) + 1;
            updateBillToken();
          }
        })
        .catch(() => {});
    }
    
    window.addEventListener('afterprint', cleanupAfterPrint);
    hideEmptyFieldsBeforePrint();
    clearNotifications();
    window.print();
    // Fallback: schedule print-ok popup even if afterprint doesn't fire
    schedulePrintOkPopup(500);
    
    // Safety timeout: release print lock after 8 seconds if afterprint event doesn't fire
    setTimeout(()=>{
      if(isPrinting){
        isPrinting = false;
      }
    }, 8000);
    
  } else {
    alert('Error saving bill: ' + (data.error || 'Unknown error'));
    isPrinting = false;
  }
})
.catch(error => {
  alert('Error saving bill: ' + error.message);
  isPrinting = false;
});

}else{
alert("Please add items to the bill before printing.");
isPrinting = false;
}
}
}
// Show a small OK popup ~2s after Print; tapping OK clears previous selected items
let _printOkTimeout = null;

function showPrintOkModal(){
	const modal = document.getElementById('printOkModal');
	if(!modal) return;
	modal.classList.add('active');
	modal.setAttribute('aria-hidden','false');
}

function hidePrintOkModal(){
	const modal = document.getElementById('printOkModal');
	if(!modal) return;
	modal.classList.remove('active');
	modal.setAttribute('aria-hidden','true');
}

function schedulePrintOkPopup(delay=2000){
	// Clear any pending
	if(_printOkTimeout) clearTimeout(_printOkTimeout);
	_printOkTimeout = setTimeout(()=>{
		showPrintOkModal();
	}, delay);
}

// Attach OK handler (attach immediately in case DOMContentLoaded already fired)
function attachPrintOkHandler(){
	const okBtn = document.getElementById('printOkButton');
	if(okBtn){
		// Avoid adding duplicate handlers
		if(okBtn._attachedPrintOk) return;
		okBtn.addEventListener('click', ()=>{
			// Clear previous selected items without confirmation
			cart = {};
			const discountEl = document.getElementById("discountPercent");
			if(discountEl) discountEl.value = 0;
			render();
			hidePrintOkModal();
		});
		okBtn._attachedPrintOk = true;
	}
}

document.addEventListener('DOMContentLoaded', attachPrintOkHandler);
attachPrintOkHandler();

// Custom Item Modal Functions
function openCustomModal(){
document.getElementById("customModal").classList.add("active");
// Prevent background scroll while modal open
document.body.classList.add('modal-open');
document.getElementById("customItemName").focus();
}

function closeCustomModal(){
document.getElementById("customModal").classList.remove("active");
// Restore background scroll
document.body.classList.remove('modal-open');
document.getElementById("customItemName").value="";
document.getElementById("customItemPrice").value="";
}

function addCustomItem(event){
event.preventDefault();
let itemName=document.getElementById("customItemName").value.trim();
let itemPrice=parseInt(document.getElementById("customItemPrice").value);
if(itemName && itemPrice > 0){
add(itemName, itemPrice);
closeCustomModal();
}
}

// Close modal when clicking outside
document.getElementById("customModal").addEventListener("click", function(e){
if(e.target === this){
closeCustomModal();
}
});

// Close modal with Escape key
document.addEventListener("keydown", function(e){
if(e.key === "Escape"){
closeCustomModal();
closePermanentModal();
}
});

// Image preview for Add Menu
function setupImagePreviews(){
  const permPreview = document.getElementById('permanentItemPreview');

  // Live preview for pasted image URL (permanent)
  const permUrlInput = document.getElementById('permanentItemImageUrl');
  if(permUrlInput && permPreview){
    permUrlInput.addEventListener('input', function(){
      const v = this.value.trim();
      permPreview.innerHTML = '';
      if(!v) return;
      const img = document.createElement('img');
      img.src = v;
      img.style.width='80px'; img.style.height='80px'; img.style.objectFit='cover'; img.style.borderRadius='6px';
      img.onerror = () => { permPreview.innerHTML = '<div style="color:#f66;font-size:12px;">Invalid image URL</div>'; };
      permPreview.appendChild(img);
    });
    }

    const grpPreview = document.getElementById('groupItemPreview');
    const grpUrlInput = document.getElementById('groupItemImageUrl');
    if(grpUrlInput && grpPreview){
      grpUrlInput.addEventListener('input', function(){
        const v = this.value.trim();
        grpPreview.innerHTML = '';
        if(!v) return;
        const img = document.createElement('img');
        img.src = v;
        img.style.width='80px'; img.style.height='80px'; img.style.objectFit='cover'; img.style.borderRadius='6px';
        img.onerror = () => { grpPreview.innerHTML = '<div style="color:#f66;font-size:12px;">Invalid image URL</div>'; };
        grpPreview.appendChild(img);
      });
    }

    }

// initialize previews on DOM ready
if(document.readyState === 'loading'){
  document.addEventListener('DOMContentLoaded', setupImagePreviews);
} else {
  setupImagePreviews();
}

// ===== PERMANENT MENU ITEM FUNCTIONS =====

function populateAddMenuCategoryDropdown(){
const select = document.getElementById("permanentItemCategory");
if (!select) return;
const currentValue = select.value;
select.innerHTML = '';

Object.keys(data).forEach(cat => {
  const option = document.createElement("option");
  option.value = cat;
  option.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
  select.appendChild(option);
});

// Restore previous selection if it still exists, otherwise select first
if(currentValue && data[currentValue]){
  select.value = currentValue;
} else if(Object.keys(data).length > 0){
  select.value = Object.keys(data)[0];
}
}

function openPermanentModal(){
if (!isAdminUser()) {
  alert('Access denied. Only administrators can add menu items.');
  return;
}
populateAddMenuCategoryDropdown();
document.getElementById("permanentModal").classList.add("active");
// Prevent background scroll while modal open
document.body.classList.add('modal-open');
// Always show the last selected tab, default to single
if (window.lastAddMenuTab === 'group') {
  showAddMenuTab('group');
} else {
  showAddMenuTab('single');
}
}

function closePermanentModal(){
  document.getElementById("permanentModal").classList.remove("active");
  // Restore background scroll
  document.body.classList.remove('modal-open');
  const pin = document.getElementById("permanentItemName"); if(pin) pin.value="";
  const pip = document.getElementById("permanentItemPrice"); if(pip) pip.value="";
  // Reset to first available category instead of hardcoding
  const firstCategory = Object.keys(data)[0];
  if(firstCategory){
    const pic = document.getElementById("permanentItemCategory"); if(pic) pic.value=firstCategory;
  }
  // Clear previews and URL for single item
  const pv = document.getElementById('permanentItemPreview'); if(pv) pv.innerHTML = '';
  const pu = document.getElementById('permanentItemImageUrl'); if(pu) pu.value = '';
  const pf = document.getElementById('permanentItemImage'); if(pf) pf.value = '';

  // Clear preview and URL for group item
  const gv = document.getElementById('groupItemPreview'); if(gv) gv.innerHTML = '';
  const gu = document.getElementById('groupItemImageUrl'); if(gu) gu.value = '';

  }

// ===== ADD CATEGORY FUNCTIONS =====

function openAddCategoryModal(){
if (!isAdminUser()) {
  alert('Access denied. Only administrators can add categories.');
  return;
}
document.getElementById("addCategoryModal").classList.add("active");
document.getElementById("newCategoryName").focus();
}

function closeAddCategoryModal(){
document.getElementById("addCategoryModal").classList.remove("active");
document.getElementById("newCategoryName").value="";
}

async function submitAddCategory(event){
event.preventDefault();
const categoryName = document.getElementById("newCategoryName").value.trim().toLowerCase();

if(!categoryName){
  alert("Please enter a category name");
  return;
}

// Check if category already exists
if(data[categoryName]){
  alert(`Category "${categoryName}" already exists!`);
  return;
}

try {
  // Save to backend
  const token = localStorage.getItem('authToken') || localStorage.getItem('token');
  const response = await fetch(apiUrl('/api/categories'), {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`
    },
    body: JSON.stringify({ name: categoryName })
  });

  const result = await response.json();

  if (!response.ok || !result.success) {
    alert(result.error || 'Failed to add category');
    return;
  }

  // Add new category to local data
  data[categoryName] = [];
  closeAddCategoryModal();

  // Refresh tabs
  renderTabs();
  load(categoryName);

  // Update Add Menu category dropdown
  if(document.getElementById("permanentItemCategory")){
    populateAddMenuCategoryDropdown();
  }

  alert(`✅ Category "${categoryName}" has been added!`);
} catch (error) {
  console.error('Error adding category:', error);
  alert('Failed to add category. Please try again.');
}
}

// ===== DELETE CATEGORY FUNCTIONS =====

function openDeleteCategoryModal(){
if (!isAdminUser()) {
  alert('Access denied. Only administrators can delete categories.');
  return;
}

// Fetch categories from backend and populate dropdown
const select = document.getElementById("categoryToDelete");
select.innerHTML = '<option value="">-- Select Category --</option>';
const token = localStorage.getItem('authToken') || localStorage.getItem('token');
fetch(apiUrl('/api/categories'), {
  headers: {
    'Authorization': `Bearer ${token}`
  }
})
.then(response => response.json())
.then(result => {
  if(result.success && result.categories && result.categories.length > 0){
    result.categories.forEach(cat => {
      const option = document.createElement("option");
      option.value = cat;
      option.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
      select.appendChild(option);
    });
  }
  document.getElementById("deleteCategoryModal").classList.add("active");
})
.catch(error => {
  alert('Failed to load categories from server.');
});
}

function closeDeleteCategoryModal(){
document.getElementById("deleteCategoryModal").classList.remove("active");
document.getElementById("categoryToDelete").value="";
}

async function submitDeleteCategory(event){
event.preventDefault();
let categoryToDelete = document.getElementById("categoryToDelete").value;
categoryToDelete = categoryToDelete.trim().toLowerCase();

if(!categoryToDelete){
  alert("Please select a category");
  return;
}

// Confirm deletion
const confirmDelete = confirm(`Are you sure you want to delete the "${categoryToDelete}" category?\n\nThis will remove all items in this category!`);

if(!confirmDelete){
  return;
}

try {
  // Delete from backend
  const token = localStorage.getItem('authToken') || localStorage.getItem('token');
  const response = await fetch(apiUrl(`/api/categories/${categoryToDelete}`), {
    method: 'DELETE',
    headers: {
      'Authorization': `Bearer ${token}`
    }
  });

  const result = await response.json();

  if (!response.ok || !result.success) {
    alert(result.error || 'Failed to delete category');
    return;
  }

  // Delete the category from local data
  delete data[categoryToDelete];
  closeDeleteCategoryModal();

  // Refresh tabs and load first available category
  renderTabs();
  const firstCategory = Object.keys(data)[0];
  if(firstCategory){
    load(firstCategory);
  } else {
    menuDiv.innerHTML = '<div style="text-align:center;padding:40px;color:#999;">No categories available</div>';
  }

  // Update Add Menu category dropdown
  if(document.getElementById("permanentItemCategory")){
    populateAddMenuCategoryDropdown();
  }

  alert(`✅ Category "${categoryToDelete}" has been deleted!`);
} catch (error) {
  console.error('Error deleting category:', error);
  alert('Failed to delete category. Please try again.');
}
}

// Helper function to render tabs
function renderTabs(){
const tabsDiv = document.getElementById("tabs");
tabsDiv.innerHTML = '';

Object.keys(data).forEach((cat, i) => {
  let btn = document.createElement("button");
  btn.textContent = cat;
  if(i === 0) btn.classList.add("active");
  
  btn.onclick = () => {
    document.querySelectorAll(".tabs button").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    load(cat);
  };
  
  tabsDiv.appendChild(btn);
});
}

// ===== DELETE MENU ITEM FUNCTIONS =====

async function openDeleteMenuModal(){
  if (!isAdminUser()) {
    alert('Access denied. Only administrators can delete menu items.');
    return;
  }

  const select = document.getElementById('itemToDelete');
  select.innerHTML = '<option value="">-- Select Item --</option>';

  const token = localStorage.getItem('authToken') || localStorage.getItem('token');
  if(!token){
    alert('Please login as administrator to manage menu items.');
    window.location.href = 'login.html';
    return;
  }

  try {
    const response = await fetch(apiUrl('/api/custom-items'), {
      headers: { 'Authorization': `Bearer ${token}` }
    });

    if(!response.ok){
      const text = await response.text().catch(()=>undefined);
      console.error('Failed to load custom items', response.status, text);
      alert('Failed to load menu items from server.');
      return;
    }

    const result = await response.json();
    if(result.success && result.items && result.items.length > 0){
      result.items.forEach(item => {
        const option = document.createElement('option');
        option.value = item.name;
        const cat = normalizeCategory(item.category);
        option.textContent = `${item.name} (${cat})`;
        select.appendChild(option);
      });
    } else {
      const option = document.createElement('option');
      option.value = '';
      option.textContent = 'No items available';
      select.appendChild(option);
    }

    document.getElementById('deleteMenuModal').classList.add('active');
  } catch (error) {
    console.error('Error fetching custom items:', error);
    alert('Failed to load menu items. Please try again.');
  }
}

function closeDeleteMenuModal(){
  document.getElementById('deleteMenuModal').classList.remove('active');
  const sel = document.getElementById('itemToDelete');
  if(sel) sel.value = '';
}

async function submitDeleteMenu(event){
  event.preventDefault();
  let name = (document.getElementById('itemToDelete').value || '').trim();
  if(!name){
    alert('Please select an item to delete');
    return;
  }

  if(!confirm(`Are you sure you want to permanently delete the "${name}" menu item? This cannot be undone.`)){
    return;
  }

  try {
    const token = localStorage.getItem('authToken') || localStorage.getItem('token');
    const response = await fetch(apiUrl(`/api/custom-items/${encodeURIComponent(name)}`), {
      method: 'DELETE',
      headers: { 'Authorization': `Bearer ${token}` }
    });

    const result = await response.json();
    if(!response.ok || !result.success){
      alert(result.error || 'Failed to delete menu item');
      return;
    }

    // Remove item from local data structure
    Object.keys(data).forEach(cat => {
      data[cat] = data[cat].filter(m => {
        if(Array.isArray(m)) return m[0] !== name;
        if(m && typeof m === 'object' && m.name) return m.name !== name;
        return true;
      });
      if(data[cat].length === 0){
        delete data[cat];
      }
    });

    // Refresh tabs and load first available category
    renderTabs();
    const firstCategory = Object.keys(data)[0];
    if(firstCategory){
      load(firstCategory);
    } else {
      menuDiv.innerHTML = '<div style="text-align:center;padding:40px;color:#999;">No categories available</div>';
    }

    // Also refresh server-side list to ensure consistency
    await loadCustomMenuItems();

    closeDeleteMenuModal();
    alert(`✅ Menu item "${name}" has been deleted`);
  } catch (error) {
    console.error('Error deleting menu item:', error);
    alert('Failed to delete menu item. Please try again.');
  }
}

/* ===== MANDI SIZE SELECTION MODAL ===== */
let currentMandiItem = null;

function showMandiSizeModal(item){
currentMandiItem = item;
document.getElementById("mandiItemTitle").textContent = item.name;
document.getElementById("soloPrice").textContent = item.prices.solo;
document.getElementById("duoPrice").textContent = item.prices.duo;
document.getElementById("trioPrice").textContent = item.prices.trio;
document.getElementById("squadPrice").textContent = item.prices.squad;
document.getElementById("mandiSizeModal").classList.add("active");
}

function closeMandiSizeModal(){
document.getElementById("mandiSizeModal").classList.remove("active");
currentMandiItem = null;
}

function selectMandiSize(size){
if(!currentMandiItem) return;

const sizeLabels = { solo: "Solo", duo: "Duo", trio: "Trio", squad: "Squad" };
const itemName = currentMandiItem.name + " - " + sizeLabels[size];
const itemPrice = currentMandiItem.prices[size];

add(itemName, itemPrice);
closeMandiSizeModal();
}

// Beverage size selection functions
let currentBeverageItem = null;

function showBeverageSizeModal(item){
currentBeverageItem = item;
document.getElementById("beverageItemTitle").textContent = item.name;

// Define all possible sizes
const allSizes = ["2L", "1L", "750ml", "250ml", "250ml_glass"];
const sizeButtonsMap = {
  "2L": document.querySelector('button[onclick="selectBeverageSize(\'2L\')"]'),
  "1L": document.querySelector('button[onclick="selectBeverageSize(\'1L\')"]'),
  "750ml": document.querySelector('button[onclick="selectBeverageSize(\'750ml\')"]'),
  "250ml": document.querySelector('button[onclick="selectBeverageSize(\'250ml\')"]'),
  "250ml_glass": document.querySelector('button[onclick="selectBeverageSize(\'250ml_glass\')"]')
};

// Show/hide size buttons based on what's available in item.prices
allSizes.forEach(size => {
  const button = sizeButtonsMap[size];
  if(button) {
    if(item.prices[size] !== undefined) {
      button.style.display = 'block';
      document.getElementById("price" + size).textContent = item.prices[size];
    } else {
      button.style.display = 'none';
    }
  }
});

document.getElementById("beverageSizeModal").classList.add("active");
}

function closeBeverageSizeModal(){
document.getElementById("beverageSizeModal").classList.remove("active");
currentBeverageItem = null;
}

function selectBeverageSize(size){
if(!currentBeverageItem) return;

const sizeLabels = { 
  "2L": "2 L", 
  "1L": "1 L", 
  "750ml": "750 ml", 
  "250ml": "250 ml", 
  "250ml_glass": "250 ml (Glass Bottle)" 
};
const itemName = currentBeverageItem.name + " - " + sizeLabels[size];
const itemPrice = currentBeverageItem.prices[size];

add(itemName, itemPrice);
closeBeverageSizeModal();
}

async function addPermanentItem(event){

  event.preventDefault();
  const isGroup = document.getElementById('addGroupTab').classList.contains('active');
  // Always disable all fields, then enable only visible set
  const singleFields = [
    'permanentItemName',
    'permanentItemPrice',
    'permanentItemCategory'
  ];
  const groupFields = [
    'groupItemName',
    'groupItemCategory',
    'groupPriceSolo',
    'groupPriceDuo',
    'groupPriceTrio',
    'groupPriceSquad'
  ];
  singleFields.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.setAttribute('disabled', 'disabled');
      el.removeAttribute('required');
    }
  });
  groupFields.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.setAttribute('disabled', 'disabled');
      el.removeAttribute('required');
    }
  });
  if(isGroup) {
    groupFields.forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.removeAttribute('disabled');
        el.setAttribute('required', 'required');
      }
    });
  } else {
    singleFields.forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.removeAttribute('disabled');
        el.setAttribute('required', 'required');
      }
    });
  }

  const token = localStorage.getItem('authToken') || localStorage.getItem('token');
  let formData = new FormData();

function isValidJWT(token) {
  if (!token) return false;
  const parts = token.split('.');
  return parts.length === 3 && parts.every(p => p.length > 0);
}

if (!isValidJWT(token)) {
  alert('Your session has expired or is invalid. Please log in again.');
  localStorage.removeItem('authToken');
  localStorage.removeItem('token');
  window.location.href = 'login.html';
  return;
}

  if(isGroup) {
    // Group item logic
    const name = document.getElementById("groupItemName").value.trim();
    const category = document.getElementById("groupItemCategory").value.trim() || "mandi";
    const priceSolo = parseFloat(document.getElementById("groupPriceSolo").value);
    const priceDuo = parseFloat(document.getElementById("groupPriceDuo").value);
    const priceTrio = parseFloat(document.getElementById("groupPriceTrio").value);
    const priceSquad = parseFloat(document.getElementById("groupPriceSquad").value);
    const imageUrl = (document.getElementById("groupItemImageUrl") || {}).value || '';
    const groupImageFile = document.getElementById('groupItemImage') ? document.getElementById('groupItemImage').files[0] : null;
      if(!name || !priceSolo || !priceDuo || !priceTrio || !priceSquad){
        alert("Please enter all prices and item name");
        return;
      }

    formData.append('name', name);
    formData.append('category', category);
    formData.append('price_solo', priceSolo);
    formData.append('price_duo', priceDuo);
    formData.append('price_trio', priceTrio);
    formData.append('price_squad', priceSquad);
    formData.append('is_group', '1');
    if (imageUrl && imageUrl.trim()) {
      formData.append('image_url', imageUrl.trim());
    } else if (groupImageFile) {
      formData.append('image', groupImageFile);
    }
    // Debug: log form data keys and token
    console.info('Adding group item, token present:', !!token);
    for (const pair of formData.entries()) console.info('formData entry:', pair[0], pair[1]);

  try {
    const response = await fetch(apiUrl('/api/custom-items'), {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`
      },
      body: formData
    });
    if (!response.ok) {
      const text = await response.text();
      console.error('Server returned non-OK response:', response.status, text);
      alert(`❌ Server error: ${response.status} - ${text}`);
      return;
    }
    console.info('Add group item response status:', response.status, 'headers:', Array.from(response.headers.entries()));

    let data = null;
    let bodyText = null;
    try {
      // try parse JSON
      data = await response.json();
    } catch (err) {
      // keep the raw text for diagnostics
      try { bodyText = await response.text(); } catch (tErr) { bodyText = String(tErr); }
      console.warn('Failed to parse JSON response for add group item:', err, 'raw response text:', bodyText);
      // If server gave 201 (created) treat as success and refresh menu — item exists on server per your report
      if(response.status === 201 || response.ok){
        alert(`✅ "${name}" group item appears to have been added (server responded ${response.status}). Menu refreshed.`);
        closePermanentModal();
        await loadCustomMenuItems();
        return;
      }
      // Otherwise show server raw text for debugging
      alert(`❌ Server response error: ${bodyText}`);
      return;
    }

    // If parse succeeded
    if(data && data.success){
      alert(`✅ "${name}" group item has been added!`);
      closePermanentModal();
      await loadCustomMenuItems();
      return;
    }

    // If server returned a non-success JSON but HTTP status indicates created, accept it as success and refresh
    if(response.status === 201){
      console.warn('Server returned HTTP 201 but JSON success flag missing; treating as created.', data);
      alert(`✅ "${name}" group item added (server returned ${response.status}). Menu refreshed.`);
      closePermanentModal();
      await loadCustomMenuItems();
      return;
    }

    // Handle authorization or explicit error messages
    if (data && data.error && data.error.toLowerCase().includes('authorization')) {
      alert('Session expired or unauthorized. Please log in again.');
      localStorage.removeItem('authToken');
      localStorage.removeItem('token');
      window.location.href = 'login.html';
      return;
    }

    alert(`❌ Error: ${ (data && data.error) ? data.error : 'Failed to add group item' }`);

  } catch (error) {
    console.error('Error adding group item:', error);
    alert(`❌ Error: ${error && error.message ? error.message : 'Failed to add group item'}`);
  }
} else {
  // Single item logic (existing)
  const itemName = document.getElementById("permanentItemName").value.trim();
  const itemPrice = parseFloat(document.getElementById("permanentItemPrice").value);
  const itemCategory = document.getElementById("permanentItemCategory").value.trim() || "mandi";
  const itemImageUrl = (document.getElementById("permanentItemImageUrl") || {}).value || '';

  if(!itemName || !itemPrice || itemPrice <= 0){
    alert("Please enter valid item name and price");
    return;
  }

  formData.append('name', itemName);
  formData.append('price', itemPrice);
  formData.append('category', itemCategory);
  if (itemImageUrl && itemImageUrl.trim()) {
    formData.append('image_url', itemImageUrl.trim());
  }

  // Debug: log form data keys and token
  console.info('Adding single item, token present:', !!token);
  for (const pair of formData.entries()) console.info('formData entry:', pair[0], pair[1]);

  try {
    const response = await fetch(apiUrl('/api/custom-items'), {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`
      },
      body: formData
    });
    if (!response.ok) {
      const text = await response.text();
      console.error('Server returned non-OK response:', response.status, text);
      alert(`❌ Server error: ${response.status} - ${text}`);
      return;
    }
    const data = await response.json();
    if(data.success){
      // Show the stored image (if any) in a small preview so admin confirms upload
      if (data.item && data.item.image_base64) {
        const mime = data.item.image_mime || 'image/jpeg';
        const img = document.createElement('img');
        img.src = `data:${mime};base64,${data.item.image_base64}`;
        img.style.maxWidth = '160px';
        img.style.maxHeight = '160px';
        img.style.objectFit = 'cover';
        img.style.display = 'block';
        img.style.marginTop = '8px';
        // Append to preview container for confirmation
        const previewContainer = document.getElementById('permanentItemPreview');
        if (previewContainer) {
          previewContainer.innerHTML = '';
          previewContainer.appendChild(img);
        }
      }

      alert(`✅ "${itemName}" has been added to the menu!`);
      closePermanentModal();
      await loadCustomMenuItems();
    } else {
      if (data.error && data.error.toLowerCase().includes('authorization')) {
        alert('Session expired or unauthorized. Please log in again.');
        localStorage.removeItem('authToken');
        localStorage.removeItem('token');
        window.location.href = 'login.html';
        return;
      }
      alert(`❌ Error: ${data.error || 'Failed to add item'}`);
    }
  } catch (error) {
    console.error('Error adding item:', error);
    alert('❌ Failed to add item to menu');
  }
}
}

// Load categories from database
async function loadCategories(){
try {
const token = localStorage.getItem('authToken') || localStorage.getItem('token');
const response = await fetch(apiUrl('/api/categories'), {
headers: {
'Authorization': `Bearer ${token}`
}
});

if (!response.ok) {
  console.error('Failed to load categories');
  return;
}

const result = await response.json();
console.log('Categories loaded from server:', result);

if(result.success && result.categories && result.categories.length > 0){
// Initialize categories in data object (will be populated with items later)
result.categories.forEach(cat => {
if(!data[cat]){
data[cat] = [];
}
});
console.log('Initialized categories:', result.categories);
}
} catch (error) {
console.error('Error loading categories:', error);
}
}

// Load custom menu items from database
async function loadCustomMenuItems(){
try {
const token = localStorage.getItem('authToken') || localStorage.getItem('token');
const response = await fetch(apiUrl('/api/custom-items'), {
headers: {
'Authorization': `Bearer ${token}`
}
});

if (!response.ok) {
  const errorText = await response.text();
  console.error('Failed to load custom items:', errorText);
  return;
}

const result = await response.json();
console.log('Custom items loaded from server:', result);

if(result.success && result.items){
  // Group items by category
  const customByCategory = {};
  result.items.forEach(item => {
    const cat = normalizeCategory(item.category);
    if(!customByCategory[cat]){
      customByCategory[cat] = [];
    }
    customByCategory[cat].push(item);
  });

  // Add custom items to existing menu or create new tabs
  for(const [category, items] of Object.entries(customByCategory)){
    if(!data[category]){
      data[category] = [];
    }
    items.forEach(item => {
      // Prefer server-provided absolute URL, then base64, then filename
      let imageUrl = "";
      if(item.image_url){
        imageUrl = item.image_url;
        console.log('Using item.image_url for item', item.name, imageUrl);
      } else if(item.image_base64){
        const mime = item.image_mime || 'image/jpeg';
        imageUrl = `data:${mime};base64,${item.image_base64}`;
        console.log('Using image_base64 for item', item.name);
      } else if(item.image && typeof item.image === 'string' && item.image !== ""){
        if(item.image.startsWith('http') || item.image.startsWith('data:')){
          imageUrl = item.image;
          console.log('Using item.image as URL for item', item.name, imageUrl);
        } else {
          imageUrl = apiUrl(`/uploads/${item.image}`);
          console.log('Using uploads path for item', item.name, imageUrl);
        }
      }

      // Find existing index (if present) so we can update instead of duplicating
      const existingIndex = data[category].findIndex(m => Array.isArray(m) ? m[0] === item.name : m.name === item.name);

        const groupPrices = item.group_prices || item.prices || (
          (item.price_solo !== undefined || item.price_duo !== undefined || item.price_trio !== undefined || item.price_squad !== undefined)
            ? {
                solo: item.price_solo,
                duo: item.price_duo,
                trio: item.price_trio,
                squad: item.price_squad
              }
            : null
        );

        if(item.is_group && groupPrices){
          const groupObj = {
            name: item.name,
            prices: {
              solo: Number(groupPrices.solo),
              duo: Number(groupPrices.duo),
              trio: Number(groupPrices.trio),
              squad: Number(groupPrices.squad)
            },
            image: imageUrl
          };

        if(existingIndex >= 0){
          // Replace existing entry
          data[category][existingIndex] = groupObj;
        } else {
          data[category].push(groupObj);
        }
      } else {
        // Single item format: [name, price, imageUrl]
        const singleArr = [item.name, item.price, imageUrl];
        if(existingIndex >= 0){
          data[category][existingIndex] = singleArr;
        } else {
          data[category].push(singleArr);
        }
      }
    });
  }

  // Refresh tabs by re-generating them
  const activeTab = document.querySelector('.tabs button.active');
  const activeCategory = activeTab ? activeTab.innerText : null;
  tabsDiv.innerHTML = '';
  menuDiv.innerHTML = '';
  Object.keys(data).forEach((cat,i)=>{
    let btn=document.createElement("button");
    btn.innerText=cat;
    if(activeCategory ? cat === activeCategory : i===0)btn.classList.add("active");
    btn.onclick=()=>{
      document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      load(cat);
    };
    tabsDiv.appendChild(btn);
  });
  // Load first tab
  if(Object.keys(data).length > 0){
    const targetCategory = activeCategory && data[activeCategory] ? activeCategory : Object.keys(data)[0];
    load(targetCategory);
  }
}
} catch (error) {
console.error('Error loading custom items:', error);
}
}

// Close permanent modal when clicking outside
document.getElementById("permanentModal").addEventListener("click", function(e){
if(e.target === this){
closePermanentModal();
}
});

// Close mandi size modal when clicking outside
document.getElementById("mandiSizeModal").addEventListener("click", function(e){
if(e.target === this){
closeMandiSizeModal();
}
});

// Close beverage size modal when clicking outside
document.getElementById("beverageSizeModal").addEventListener("click", function(e){
if(e.target === this){
closeBeverageSizeModal();
}
});

// Header Icons Event Listeners
document.addEventListener('DOMContentLoaded', ()=>{
  // Analytics button event handler is now set in adjustAdminOnlyUI for admin only

  const printQueueBtn = document.getElementById('printQueueBtn');
  if(printQueueBtn){
    try {
      printQueueBtn.addEventListener('click', ()=>{
        openPrintQueueModal();
      });
    } catch (e) {
      console.error('Could not attach printQueue click listener:', e);
    }

    // Fallback for print queue button
    printQueueBtn.setAttribute('onclick', "openPrintQueueModal()");
    printQueueBtn.style.cursor = 'pointer';
  }
});

// Print Queue Functions
function openPrintQueueModal(){
  document.getElementById("printQueueModal").classList.add("active");
  loadPrintQueue();
}

function closePrintQueueModal(){
  document.getElementById("printQueueModal").classList.remove("active");
}

// Close print queue modal when clicking outside
document.getElementById("printQueueModal").addEventListener("click", function(e){
  if(e.target === this){
    closePrintQueueModal();
  }
});

async function loadPrintQueue(){
  const container = document.getElementById("printQueueList");
  container.innerHTML = '<p style="text-align: center; color: var(--muted);">Loading...</p>';
  
  try {
    const token = localStorage.getItem('authToken') || localStorage.getItem('token');
    console.log('📥 loadPrintQueue called');
    console.log('🔐 Token exists:', !!token);
    
    if(!token){
      console.error('❌ No auth token found');
      container.innerHTML = '<p style="text-align: center; color: var(--danger);">Please login to view print queue</p>';
      return;
    }
    
    console.log('📡 Fetching from:', apiUrl('/api/print-queue'));
    const response = await fetch(apiUrl('/api/print-queue'), {
      method: 'GET',
      headers: {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      }
    });
    
    console.log('📊 Response status:', response.status, response.statusText);
    if(!response.ok){
      const errorData = await response.json().catch(() => ({}));
      console.error('❌ API Error:', errorData);
      throw new Error(errorData.error || `Failed to fetch print queue (HTTP ${response.status})`);
    }
    
    const data = await response.json();
    console.log('✅ API Response:', data);
    
    if(data.success && data.requests && data.requests.length > 0){
      console.log(`📋 Found ${data.requests.length} pending requests`);
      container.innerHTML = '';
      data.requests.forEach(request => {
        console.log('  Request:', request);
        const requestCard = document.createElement('div');
        const billData = request.billData || {};
        const items = Array.isArray(billData.items) ? billData.items : [];
        const totalAmount = Number(billData.total) || 0;
        const createdAt = request.createdAt ? new Date(request.createdAt).toLocaleString() : 'Unknown time';
        requestCard.style.cssText = `
          background: var(--card-bg);
          border: 1px solid var(--gold);
          border-radius: 8px;
          padding: 15px;
          margin-bottom: 15px;
        `;
        
        const itemsList = items.length > 0 ? items.map(item => 
          `<div style="display: flex; justify-content: space-between; padding: 5px 0;">
            <span>${item.name} x ${item.qty}</span>
            <span>\u20B9${(item.price * item.qty).toFixed(2)}</span>
          </div>`
        ).join('') : '<div style="color: var(--muted); font-size: 12px;">No items</div>';
        
        requestCard.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 style="margin: 0; color: var(--gold);">Request from: ${request.createdBy}</h3>
            <span style="color: var(--muted); font-size: 12px;">${createdAt}</span>
          </div>
          <div style="border-top: 1px solid var(--muted); padding-top: 10px;">
            ${itemsList}
            <div style="border-top: 2px solid var(--gold); margin-top: 10px; padding-top: 10px;">
              <strong>Total: \u20B9${totalAmount.toFixed(2)}</strong>
            </div>
            <div style="margin-top: 5px; color: var(--muted); font-size: 12px;">
              <div>Payment: ${billData.payment || 'Cash / UPI'}</div>
              <div>Order Type: ${billData.orderType || 'Dine-in / Take Out'}</div>
              <div>Table No: ${billData.tableNo || 'N/A'}</div>
              <div>Token: ${billData.token || 0}</div>
            </div>
          </div>
          <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button 
              onclick="processPrintRequest('${request._id}', ${JSON.stringify(billData).replace(/"/g, '&quot;')})"
              style="
                flex: 1;
                padding: 12px;
                background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
                color: white;
                border: none;
                border-radius: 6px;
                font-size: 16px;
                font-weight: bold;
                cursor: pointer;
              "
            >Transfer</button>
            <button 
              onclick="deletePrintRequest('${request._id}')"
              style="
                flex: 1;
                padding: 12px;
                background: linear-gradient(135deg, var(--danger) 0%, #ff6b6b 100%);
                color: white;
                border: none;
                border-radius: 6px;
                font-size: 16px;
                font-weight: bold;
                cursor: pointer;
              "
            >Delete</button>
          </div>
        `;
        
        container.appendChild(requestCard);
      });
    } else if (data.success) {
      console.log('ℹ️ No pending print requests');
      container.innerHTML = '<p style="text-align: center; color: var(--muted);">No pending print requests</p>';
    } else {
      console.error('❌ API returned success:false -', data.error);
      container.innerHTML = `<p style="text-align: center; color: var(--danger);">${data.error || 'Failed to fetch print queue'}</p>`;
    }
  } catch(error) {
    console.error('Error loading print queue:', error);
    container.innerHTML = `<p style="text-align: center; color: var(--danger);">Error loading print queue: ${error.message}</p>`;
  }
}

async function processPrintRequest(requestId, billData){
  try {
    // Transfer bill data to the right-side billing panel
    console.log('📤 Transferring bill data to panel:', billData);
    console.log('❓ billData keys:', Object.keys(billData));
    console.log('❓ tableNo value:', billData.tableNo);
    console.log('❓ tableNo type:', typeof billData.tableNo);
    
    // Clear the current bill first
    cart = {};
    
    // Use the transferred bill number (token) - mark as transferred
    billNumber = billData.token || 0;
    displayToken = billNumber; // show transferred token
    isTokenReserved = true;
    updateBillToken();
    isTransferredBill = true;  // Flag to prevent counter increment on print
    
    // Load the items from the print request into the cart
    if (billData.items && Array.isArray(billData.items)) {
      billData.items.forEach(item => {
        // Use item name as key, matching the cart structure from add() function
        cart[item.name] = {
          price: item.price,
          qty: item.qty
        };
      });
      console.log('✅ Items added to cart:', cart);
    }
    
    // Set the payment method if available
    if (billData.payment) {
      const paymentSelect = document.getElementById('paymentMethod');
      if (paymentSelect) {
        paymentSelect.value = billData.payment;
        console.log('✅ Payment method set to:', billData.payment);
      }
    }
    
    // Set the order type if available
    if (billData.orderType) {
      const orderTypeSelect = document.getElementById('orderType');
      if (orderTypeSelect) {
        orderTypeSelect.value = billData.orderType;
        console.log('✅ Order type set to:', billData.orderType);
      }
    }
    
    // Set the discount percentage if available
    if (billData.discount !== undefined && billData.discount !== null) {
      const discountInput = document.getElementById('discountPercent');
      if (discountInput) {
        discountInput.value = billData.discount;
        console.log('✅ Discount percentage set to:', billData.discount);
      }
    }
    
    // Set table number if available
    if (billData.tableNo !== undefined && billData.tableNo !== null) {
      const tableInput = document.getElementById('tableNo');
      if (tableInput) {
        tableInput.value = billData.tableNo;
        console.log('✅ Table number set to:', billData.tableNo);
      }
    }
    
    // Update bill number display
    updateBillToken();
    
    // Refresh the bill display
    render();
    
    // Close the print queue modal
    closePrintQueueModal();
    
    // Show confirmation message
    showNotification('✅ Bill data transferred to panel!', 'success');
    
    // Delete the print request from the database
    const token = localStorage.getItem('authToken');
    const response = await fetch(apiUrl(`/api/print-queue/${requestId}`), {
      method: 'DELETE',
      headers: {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      }
    });
    
    if(!response.ok){
      console.warn('⚠️ Failed to delete print request, but data was transferred');
    }
    
    // Reload the queue in background
    loadPrintQueue();
    
  } catch(error) {
    console.error('Error processing print request:', error);
    alert('Error transferring bill: ' + error.message);
  }
}

async function deletePrintRequest(requestId) {
  // Confirm deletion
  if (!confirm('Are you sure you want to delete this print request?')) {
    return;
  }

  try {
    const token = localStorage.getItem('authToken') || localStorage.getItem('token');
    
    if(!token){
      console.error('❌ No auth token found');
      alert('Please login to delete print requests');
      return;
    }
    
    console.log('🗑️ Deleting print request:', requestId);
    const response = await fetch(apiUrl(`/api/print-queue/${requestId}`), {
      method: 'DELETE',
      headers: {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      }
    });
    
    console.log('📊 Response status:', response.status, response.statusText);
    if(!response.ok){
      const errorData = await response.json().catch(() => ({}));
      console.error('❌ Delete API Error:', errorData);
      throw new Error(errorData.error || `Failed to delete print request (HTTP ${response.status})`);
    }
    
    const data = await response.json();
    console.log('✅ Delete Response:', data);
    
    if(data.success){
      console.log('✅ Print request deleted successfully');
      showNotification('✅ Print request deleted successfully', 'success');
      // Reload the print queue to reflect the deletion
      loadPrintQueue();
    } else {
      alert(`❌ Error: ${data.error || 'Failed to delete print request'}`);
    }
  } catch(error) {
    console.error('Error deleting print request:', error);
    alert('Error deleting print request: ' + error.message);
  }
}

function showNotification(message, type = 'info') {
  // Create notification element
  const notification = document.createElement('div');
  notification.className = 'app-notification';
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    background: ${type === 'success' ? '#4caf50' : '#2196f3'};
    color: white;
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    z-index: 10000;
    animation: slideIn 0.3s ease-out;
    font-weight: 500;
  `;
  notification.textContent = message;
  
  // Add styles to document if not already there
  if (!document.querySelector('style[data-notification]')) {
    const style = document.createElement('style');
    style.setAttribute('data-notification', 'true');
    style.textContent = `
      @keyframes slideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      @keyframes slideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(400px);
          opacity: 0;
        }
      }
    `;
    document.head.appendChild(style);
  }
  
  document.body.appendChild(notification);
  
  // Auto remove after 4 seconds
  setTimeout(() => {
    notification.style.animation = 'slideOut 0.3s ease-out';
    setTimeout(() => notification.remove(), 300);
  }, 4000);
}

function clearNotifications() {
  document.querySelectorAll('.app-notification').forEach(el => el.remove());
}

window.addEventListener('beforeprint', clearNotifications);

// Initial render
render();

</script>

<!-- Print OK confirmation modal (appears after Print) -->
<div class="print-ok-modal" id="printOkModal" aria-hidden="true">
  <div class="print-ok-content" role="dialog" aria-modal="true" aria-labelledby="printOkTitle">
    <p id="printOkTitle">Tap OK to clear previous items</p>
    <button id="printOkButton" class="print-ok-btn">OK</button>
  </div>
</div>

</body>
</html>
